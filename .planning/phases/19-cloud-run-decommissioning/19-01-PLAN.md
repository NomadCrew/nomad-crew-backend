---
phase: 19-cloud-run-decommissioning
plan: 01
type: execute
---

<objective>
Safely decommission GCP Cloud Run and clean up all associated resources.

Purpose: Complete infrastructure migration to AWS, eliminate GCP recurring costs (~$24/month savings).
Output: Cloud Run service deleted, Artifact Registry cleaned, GitHub secrets removed, zero GCP charges.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-monitoring-setup/18-01-SUMMARY.md

**GCP Project:** nomadcrew-11fd4
**GCP Region:** us-east1
**Artifact Registry:** us-east1-docker.pkg.dev/nomadcrew-11fd4/{repository}/{service}

**AWS Production URL:** https://api.nomadcrew.uk (live since 2026-01-12)
**Monitoring:** Grafana Cloud synthetic checks active, Discord alerting configured

**Prior Decision:** Migrated to AWS due to Oracle Cloud ARM capacity issues (Phase 13)

**Constraining decisions:**
- Phase 15: Cloud Run workflows archived to .github/workflows-archived/
- Phase 16: Application deployed and healthy on AWS EC2
- Phase 18: Monitoring in place for 48+ hour stability verification

**GitHub Secret to Remove:** GCP_SA_KEY (documented in .github/SECRETS.md)
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Verify AWS stability and inventory GCP resources</action>
  <instructions>
    **1. Verify AWS is stable (should show healthy responses):**
    ```bash
    curl -s https://api.nomadcrew.uk/health | jq .
    curl -s https://api.nomadcrew.uk/health/liveness
    ```

    **2. Check Grafana Cloud for any recent incidents:**
    Visit: https://nomadcrew5.grafana.net/a/grafana-synthetic-monitoring-app
    Confirm: All 3 checks showing green/passing

    **3. Fix gcloud CLI (installation corrupted):**
    Open PowerShell as Administrator and run:
    ```powershell
    # Reinstall Google Cloud SDK
    (New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:TEMP\GoogleCloudSDKInstaller.exe")
    Start-Process "$env:TEMP\GoogleCloudSDKInstaller.exe" -Wait
    ```
    Or download from: https://cloud.google.com/sdk/docs/install

    After installation, authenticate:
    ```bash
    gcloud auth login
    gcloud config set project nomadcrew-11fd4
    ```

    **4. Inventory GCP resources:**
    ```bash
    # List Cloud Run services
    gcloud run services list --region=us-east1

    # List Artifact Registry repositories
    gcloud artifacts repositories list --location=us-east1

    # List container images (adjust repository name from above)
    gcloud artifacts docker images list us-east1-docker.pkg.dev/nomadcrew-11fd4/{REPOSITORY_NAME}
    ```

    Note the exact service name and repository name for next task.
  </instructions>
  <verification>
    - AWS health check returns 200 with healthy status
    - Grafana shows all checks passing
    - gcloud commands work
    - Cloud Run service name identified
    - Artifact Registry repository name identified
  </verification>
  <resume-signal>Provide: SERVICE_NAME and REPOSITORY_NAME, then type "ready to delete"</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Delete Cloud Run service and Artifact Registry</action>
  <instructions>
    **DESTRUCTIVE OPERATIONS - Double-check before proceeding!**

    **1. Delete Cloud Run service:**
    ```bash
    # Replace {SERVICE_NAME} with actual name from previous task
    gcloud run services delete {SERVICE_NAME} --region=us-east1 --quiet
    ```
    Confirm deletion when prompted.

    **2. Delete all container images:**
    ```bash
    # Replace {REPOSITORY_NAME} with actual name from previous task
    # List images first to see what will be deleted
    gcloud artifacts docker images list us-east1-docker.pkg.dev/nomadcrew-11fd4/{REPOSITORY_NAME}

    # Delete all images (or repository entirely)
    gcloud artifacts repositories delete {REPOSITORY_NAME} --location=us-east1 --quiet
    ```

    **3. Verify resources are gone:**
    ```bash
    gcloud run services list --region=us-east1
    gcloud artifacts repositories list --location=us-east1
    ```
    Both commands should return empty or show no nomadcrew resources.
  </instructions>
  <verification>
    - Cloud Run service deleted (gcloud run services list shows none)
    - Artifact Registry repository deleted
    - No container images remaining
  </verification>
  <resume-signal>Type "deleted" when both Cloud Run and Artifact Registry are removed</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Remove GitHub secret and verify GCP billing</action>
  <instructions>
    **1. Remove GCP_SA_KEY from GitHub:**
    Visit: https://github.com/NomadCrew/nomad-crew-backend/settings/secrets/actions
    Find and delete: `GCP_SA_KEY`

    **2. Verify archived workflows won't run:**
    The Cloud Run workflows are in `.github/workflows-archived/` which GitHub ignores.
    No action needed - just confirm they exist in archived folder.

    **3. Check GCP Billing:**
    Visit: https://console.cloud.google.com/billing/
    - Verify no active charges for nomadcrew-11fd4
    - Optionally: Disable billing for the project entirely
    - Optionally: Delete the project if nothing else uses it

    ```bash
    # Alternative: Check via CLI
    gcloud billing accounts list
    gcloud billing projects describe nomadcrew-11fd4
    ```

    **4. Final AWS verification:**
    ```bash
    curl -s https://api.nomadcrew.uk/health | jq .
    ```
    Confirm API still responds correctly after GCP cleanup.
  </instructions>
  <verification>
    - GCP_SA_KEY secret removed from GitHub
    - GCP billing shows no unexpected charges
    - AWS API still healthy
  </verification>
  <resume-signal>Type "complete" when all cleanup verified</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] AWS production API responding at https://api.nomadcrew.uk
- [ ] Cloud Run service deleted
- [ ] Artifact Registry cleaned up
- [ ] GCP_SA_KEY removed from GitHub secrets
- [ ] GCP billing verified (no charges)
- [ ] Grafana monitoring shows no issues
</verification>

<success_criteria>

- Cloud Run service fully deleted
- No GCP container images remaining
- GitHub secrets cleaned up
- Zero GCP infrastructure costs going forward
- AWS deployment unaffected and stable
- v1.1 Infrastructure Migration milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-cloud-run-decommissioning/19-01-SUMMARY.md`:

# Phase 19 Plan 01: Cloud Run Decommissioning Summary

**[One-liner: what was accomplished]**

## Accomplishments

- Cloud Run service deleted
- Artifact Registry cleaned up
- GitHub secrets removed
- GCP billing verified

## Resources Deleted

| Resource | Type | Project |
|----------|------|---------|
| {service-name} | Cloud Run | nomadcrew-11fd4 |
| {repository-name} | Artifact Registry | nomadcrew-11fd4 |

## Cost Impact

- GCP: $24/month â†’ $0/month
- AWS: ~$163/month (m8g.large)
- Net monthly: ~$139/month vs $24/month (higher but more capable)

## Verification

- AWS API: https://api.nomadcrew.uk - Healthy
- Grafana checks: All passing
- GCP resources: Deleted

## Next Steps

- v1.1 Infrastructure Migration milestone COMPLETE
- Ready for Phase 20: Windows DevX for Mobile Development (if desired)
</output>
