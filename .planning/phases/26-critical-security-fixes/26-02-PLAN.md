---
phase: 26-critical-security-fixes
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - config/config.go
  - router/router.go
  - middleware/rate_limit.go
autonomous: true

must_haves:
  truths:
    - "X-Forwarded-For header only trusted from configured proxy CIDRs"
    - "gin.Context.ClientIP() returns actual client IP, not spoofed value"
    - "TrustedProxies can be configured via environment variable"
  artifacts:
    - path: "config/config.go"
      provides: "TrustedProxies field in ServerConfig"
      contains: "TrustedProxies"
    - path: "router/router.go"
      provides: "SetTrustedProxies configuration"
      contains: "SetTrustedProxies"
  key_links:
    - from: "router/router.go"
      to: "config.ServerConfig.TrustedProxies"
      via: "deps.Config.Server.TrustedProxies"
      pattern: "SetTrustedProxies.*TrustedProxies"
    - from: "middleware/rate_limit.go"
      to: "gin.Context"
      via: "c.ClientIP()"
      pattern: "return c\\.ClientIP\\(\\)"
---

<objective>
Configure Gin trusted proxies and update IP extraction for SEC-02.

Purpose: The current getClientIP function blindly trusts X-Forwarded-For headers from any client, allowing attackers to spoof their IP and bypass rate limiting. Gin's built-in SetTrustedProxies with ClientIP() solves this securely.
Output: Modified config, router, and rate_limit.go to use Gin's trusted proxy mechanism.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SECURITY.md
@.planning/phases/26-critical-security-fixes/26-01-SUMMARY.md
@config/config.go
@router/router.go
@middleware/rate_limit.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TrustedProxies to ServerConfig</name>
  <files>config/config.go</files>
  <action>
Add TrustedProxies field to ServerConfig struct and configure its loading:

1. Update ServerConfig struct (around line 29-36):
```go
// ServerConfig holds server-specific configuration.
type ServerConfig struct {
    Environment    Environment `mapstructure:"ENVIRONMENT" yaml:"environment"`
    Port           string      `mapstructure:"PORT" yaml:"port"`
    AllowedOrigins []string    `mapstructure:"ALLOWED_ORIGINS" yaml:"allowed_origins"`
    Version        string      `mapstructure:"VERSION" yaml:"version"`
    JwtSecretKey   string      `mapstructure:"JWT_SECRET_KEY" yaml:"jwt_secret_key"`
    FrontendURL    string      `mapstructure:"FRONTEND_URL" yaml:"frontend_url"`
    // TrustedProxies is a list of CIDR ranges or IPs of trusted reverse proxies.
    // If empty, X-Forwarded-For headers are ignored entirely (safe default).
    // Examples: ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
    TrustedProxies []string `mapstructure:"TRUSTED_PROXIES" yaml:"trusted_proxies"`
}
```

2. Add default value in LoadConfig (around line 155):
After `v.SetDefault("SERVER.ALLOWED_ORIGINS", []string{"*"})` add:
```go
v.SetDefault("SERVER.TRUSTED_PROXIES", []string{}) // Empty = trust no one (safe default)
```

3. Add environment variable binding in envBindings array (around line 194):
After `{"SERVER.JWT_SECRET_KEY", "JWT_SECRET_KEY"},` add:
```go
{"SERVER.TRUSTED_PROXIES", "TRUSTED_PROXIES"},
```

4. Add logging for trusted proxies config in LoadConfig (around line 247):
Update the log.Infow call to include trusted_proxies:
```go
log.Infow("Configuration loaded",
    "environment", env,
    "server_port", v.GetString("SERVER.PORT"),
    "db_host", v.GetString("DATABASE.HOST"),
    "allowed_origins", v.GetString("SERVER.ALLOWED_ORIGINS"),
    "trusted_proxies", v.GetStringSlice("SERVER.TRUSTED_PROXIES"),
    // ... rest of existing fields
)
```
  </action>
  <verify>
Run `go build ./config/...` to verify the code compiles without errors.
  </verify>
  <done>
ServerConfig has TrustedProxies field, defaults to empty slice, bindable via TRUSTED_PROXIES env var.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Gin SetTrustedProxies in router</name>
  <files>router/router.go</files>
  <action>
Add import for logger package and configure trusted proxies early in SetupRouter:

1. Add logger import if not present:
```go
import (
    // ... existing imports
    "github.com/NomadCrew/nomad-crew-backend/logger"
)
```

2. At the beginning of SetupRouter function, right after creating the Gin engine (after line 93 `r := gin.Default()`), add trusted proxy configuration:

```go
// SetupRouter configures and returns the main Gin engine with all routes defined.
func SetupRouter(deps Dependencies) *gin.Engine {
    r := gin.Default()

    // SECURITY: Configure trusted proxies before any other middleware
    // This ensures c.ClientIP() returns the actual client IP, not spoofed headers
    if len(deps.Config.Server.TrustedProxies) == 0 {
        // No trusted proxies configured - disable proxy header parsing entirely
        // This is the SAFE default: X-Forwarded-For headers are ignored
        if err := r.SetTrustedProxies(nil); err != nil {
            logger.GetLogger().Errorw("Failed to set trusted proxies", "error", err)
        }
        logger.GetLogger().Info("Trusted proxies disabled - using RemoteAddr directly for client IP")
    } else {
        // Specific trusted proxies configured - only trust headers from these IPs/CIDRs
        if err := r.SetTrustedProxies(deps.Config.Server.TrustedProxies); err != nil {
            logger.GetLogger().Fatalw("Invalid trusted proxy configuration", "error", err)
        }
        logger.GetLogger().Infow("Trusted proxies configured",
            "proxies", deps.Config.Server.TrustedProxies)
    }

    // Global Middleware
    r.Use(middleware.RequestIDMiddleware())           // Add RequestID middleware
    // ... rest of middleware
```

Note: The check uses len() == 0 to handle both nil and empty slice cases.
  </action>
  <verify>
Run `go build ./router/...` to verify the code compiles without errors.
  </verify>
  <done>
Router configures SetTrustedProxies based on config - nil if empty, specific CIDRs if configured.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update getClientIP to use c.ClientIP()</name>
  <files>middleware/rate_limit.go</files>
  <action>
Simplify getClientIP to use Gin's built-in ClientIP() which respects trusted proxy config:

Replace the entire getClientIP function (lines 114-134) with:

```go
// getClientIP extracts the real client IP from the request.
// SECURITY: Uses Gin's built-in ClientIP() which:
// 1. Only parses X-Forwarded-For/X-Real-IP if RemoteAddr is from a trusted proxy
// 2. Falls back to RemoteAddr if the request is not from a trusted proxy
// 3. Trusted proxies are configured via r.SetTrustedProxies() in router setup
func getClientIP(c *gin.Context) string {
    return c.ClientIP()
}
```

This removes the vulnerable code that blindly trusted X-Forwarded-For from any source.
  </action>
  <verify>
Run `go build ./middleware/...` to verify the code compiles without errors.
  </verify>
  <done>
getClientIP uses c.ClientIP() which respects trusted proxy configuration.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` passes without errors
2. `go vet ./...` passes without warnings
3. Review config/config.go to confirm:
   - ServerConfig has TrustedProxies []string field
   - Default is empty slice
   - TRUSTED_PROXIES env var is bound
4. Review router/router.go to confirm:
   - SetTrustedProxies(nil) called when no proxies configured
   - SetTrustedProxies(proxies) called when proxies configured
5. Review middleware/rate_limit.go to confirm:
   - getClientIP returns c.ClientIP() directly
   - No manual X-Forwarded-For parsing
</verification>

<success_criteria>
- TrustedProxies configurable via TRUSTED_PROXIES environment variable
- Empty TRUSTED_PROXIES results in SetTrustedProxies(nil) - ignores all forwarded headers
- Configured TRUSTED_PROXIES results in SetTrustedProxies(cidrs) - only trusts those IPs
- getClientIP() uses c.ClientIP() which respects the trusted proxy configuration
- Code compiles and passes vet checks
</success_criteria>

<output>
After completion, create `.planning/phases/26-critical-security-fixes/26-02-SUMMARY.md`
</output>
