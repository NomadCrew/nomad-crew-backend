# Phase 06: Notification Domain Refactoring - Plan 02

## Notification Handler Pattern Standardization

**Created:** 2026-01-12
**Status:** Ready for Execution
**Estimated Tasks:** 5

---

## Context

### Current State Analysis

`handlers/notification_handler.go` (280 lines) does NOT follow established patterns:

| Pattern | Expected | Current |
|---------|----------|---------|
| User ID extraction | `getUserIDFromContext(c)` | `utils.GetUserIDFromContext(c.Request.Context())` |
| Error responses | `c.Error(errors.X())` | `c.JSON(http.StatusX, gin.H{"error": "..."})` |
| UUID parsing | Could use helper | Inline with manual error handling |

### Batch Notification Status

The batch notification TODO in `internal/notification/client.go:106` is for the external NotificationFacadeService API. The Expo push service (`services/push_service.go`) already has proper batching with `MaxBatchSize = 100`.

**Decision:** Document batch TODO as out of scope for this refactoring - it's an enhancement for the external API, not a bug.

---

## Objective

1. **Standardize notification handler** with established patterns
2. **Improve error handling consistency** using `c.Error()` pattern
3. **Document batch notification** as future enhancement

---

## Tasks

### Task 1: Refactor GetNotificationsByUser

**File:** `handlers/notification_handler.go`

**Changes:**
- Replace `utils.GetUserIDFromContext(c.Request.Context())` with `getUserIDFromContext(c)`
- Replace inline JSON error responses with `c.Error(errors.X())`
- Use established patterns for validation errors

**Before (lines 44-56):**
```go
func (h *NotificationHandler) GetNotificationsByUser(c *gin.Context) {
    userIDStr, err := utils.GetUserIDFromContext(c.Request.Context())
    if err != nil {
        h.logger.Warn("Unauthorized attempt to get notifications", zap.Error(err))
        c.JSON(http.StatusUnauthorized, gin.H{"error": "Unauthorized"})
        return
    }
    userID, err := uuid.Parse(userIDStr)
    if err != nil {
        h.logger.Error("Failed to parse user ID from context", ...)
        c.JSON(http.StatusInternalServerError, gin.H{"error": "Internal server error"})
        return
    }
```

**After:**
```go
func (h *NotificationHandler) GetNotificationsByUser(c *gin.Context) {
    userIDStr := getUserIDFromContext(c)
    if userIDStr == "" {
        _ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated"))
        return
    }
    userID, err := uuid.Parse(userIDStr)
    if err != nil {
        _ = c.Error(errors.InternalServerError("invalid user ID format"))
        return
    }
```

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `c.Error()` for all error cases

---

### Task 2: Refactor MarkNotificationAsRead

**File:** `handlers/notification_handler.go`

**Changes:**
- Same pattern updates as Task 1
- Keep the store.ErrNotFound/ErrForbidden checks but use c.Error()

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `c.Error()` for all error cases

---

### Task 3: Refactor MarkAllNotificationsRead

**File:** `handlers/notification_handler.go`

**Changes:**
- Same pattern updates as Task 1

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `c.Error()` for all error cases

---

### Task 4: Refactor DeleteNotification and DeleteAllNotifications

**File:** `handlers/notification_handler.go`

**Changes:**
- Apply same pattern to both delete methods
- Keep the store.ErrNotFound/ErrForbidden checks but use c.Error()

**Verification:**
- [ ] Both methods use `getUserIDFromContext(c)`
- [ ] Both methods use `c.Error()` for all error cases

---

### Task 5: Document batch notification as out of scope

**File:** `internal/notification/client.go`

**Changes:**
- Update TODO comment to clarify this is a future enhancement, not a bug
- Add note that Expo push service already has batching

**Before (line 105-106):**
```go
// SendBatch sends multiple notifications (currently sends them individually)
// TODO: Implement batch endpoint when available
```

**After:**
```go
// SendBatch sends multiple notifications (currently sends them individually).
// NOTE: This is for the external notification API. The Expo push service
// (services/push_service.go) already has proper batching with MaxBatchSize=100.
// Enhancement: Implement batch endpoint when available in external API.
```

**Verification:**
- [ ] TODO comment updated with context

---

## Files Modified

| File | Action |
|------|--------|
| `handlers/notification_handler.go` | Refactor all 5 handler methods |
| `internal/notification/client.go` | Update batch TODO comment |

## Imports to Add

```go
import (
    "github.com/NomadCrew/nomad-crew-backend/errors"
)
```

## Imports to Remove

```go
// Remove if no longer used after refactoring
import (
    "github.com/NomadCrew/nomad-crew-backend/internal/utils"
)
```

---

## Success Criteria

- [ ] All 5 handler methods use `getUserIDFromContext(c)`
- [ ] All 5 handler methods use `c.Error()` for errors
- [ ] Batch notification documented as future enhancement
- [ ] `go build ./...` passes
- [ ] No regressions in notification functionality

---

## Execution Order

1. Task 1: Refactor GetNotificationsByUser
2. Tasks 2-3: Refactor mark methods
3. Task 4: Refactor delete methods
4. Task 5: Document batch notification
5. Verify build

---

*Phase: 06-notification-domain-refactoring*
*Plan: 06-02*
*Created: 2026-01-12*
