# Phase 10: Middleware and Cross-Cutting Concerns - Plan 01

## Error Handling Pattern Standardization

**Created:** 2026-01-12
**Status:** Ready for Execution
**Estimated Tasks:** 3

---

## Context

### Analysis Summary

The middleware layer has been analyzed for consistency with established handler patterns.

| File | Error Pattern | Status |
|------|---------------|--------|
| `middleware/auth.go` | `c.Error()` + `c.Abort()` | ✅ Correct |
| `middleware/rbac.go` | `c.AbortWithStatusJSON()` | ❌ Needs update |
| `middleware/rate_limit.go` | `c.AbortWithStatusJSON()` | ❌ Needs update |
| `middleware/error_handler.go` | Handles AppError | ✅ Correct |
| `middleware/jwt_validator.go` | N/A (returns errors) | ✅ Correct |
| `middleware/context_keys.go` | N/A (constants only) | ✅ Correct |
| `types/permission_matrix.go` | N/A (logic only) | ✅ Correct |

### Problem

- `rbac.go` uses `c.AbortWithStatusJSON()` directly instead of `c.Error()` + `c.Abort()`
- `rate_limit.go` uses `c.AbortWithStatusJSON()` directly
- This bypasses the ErrorHandler middleware, causing inconsistent error responses

### Established Pattern (from auth.go)

```go
// Correct pattern for middleware errors:
_ = c.Error(apperrors.Unauthorized("code", "message"))
c.Abort()
return
```

---

## Objective

Standardize middleware error handling to use `c.Error()` + `c.Abort()` pattern, ensuring all errors flow through ErrorHandler for consistent responses.

---

## Tasks

### Task 1: Standardize rbac.go error handling

**File:** `middleware/rbac.go`

**Changes:**
1. Add import for `apperrors "github.com/NomadCrew/nomad-crew-backend/errors"`
2. Update `RequireRole` function (3 error cases):
   - Missing trip ID: `c.Error(apperrors.ValidationFailed(...))` + `c.Abort()`
   - Missing user ID: `c.Error(apperrors.Unauthorized(...))` + `c.Abort()`
   - Failed to get role: `c.Error(apperrors.Unauthorized(...))` + `c.Abort()`
   - Permission denied: `c.Error(apperrors.Forbidden(...))` + `c.Abort()`

3. Update `RequirePermission` function (4 error cases):
   - Missing trip ID: `c.Error(apperrors.ValidationFailed(...))` + `c.Abort()`
   - Missing user ID: `c.Error(apperrors.Unauthorized(...))` + `c.Abort()`
   - Not a trip member: `c.Error(apperrors.Forbidden(...))` + `c.Abort()`
   - Permission denied: `c.Error(apperrors.Forbidden(...))` + `c.Abort()`

4. Update `RequireTripMembership` function (2 error cases):
   - Missing trip/user ID: `c.Error(apperrors.ValidationFailed(...))` + `c.Abort()`
   - Not a member: `c.Error(apperrors.Forbidden(...))` + `c.Abort()`

**Verification:**
- [ ] All `c.AbortWithStatusJSON` replaced with `c.Error()` + `c.Abort()`
- [ ] Import added for apperrors

---

### Task 2: Standardize rate_limit.go error handling

**File:** `middleware/rate_limit.go`

**Changes:**
1. Add import for `apperrors "github.com/NomadCrew/nomad-crew-backend/errors"`
2. Update `WSRateLimiter` function (3 error cases):
   - Missing user ID: `c.Error(apperrors.Unauthorized(...))` + `c.Abort()`
   - Rate limit check failed: `c.Error(apperrors.InternalServerError(...))` + `c.Abort()`
   - Too many connections: `c.Error(apperrors.RateLimitExceeded(...))` + `c.Abort()`

3. Update `AuthRateLimiter` function (1 error case):
   - Rate limit exceeded: `c.Error(apperrors.RateLimitExceeded(...))` + `c.Abort()`

**Note:** Keep rate limit headers (`X-RateLimit-*`) as they provide useful client information.

**Verification:**
- [ ] All `c.AbortWithStatusJSON` replaced with `c.Error()` + `c.Abort()`
- [ ] Rate limit headers preserved
- [ ] Import added for apperrors

---

### Task 3: Verify RateLimitExceeded error type exists

**File:** `errors/errors.go`

Check if `RateLimitExceeded` error helper exists. If not, we'll use `TooManyRequests` or add it.

**Action:** Check errors package and add helper if needed.

---

## Files Modified

| File | Action |
|------|--------|
| `middleware/rbac.go` | Standardize error handling |
| `middleware/rate_limit.go` | Standardize error handling |
| `errors/errors.go` | Add RateLimitExceeded if needed |

---

## Success Criteria

- [ ] All middleware uses `c.Error()` + `c.Abort()` pattern
- [ ] Consistent with auth.go pattern
- [ ] `go build ./...` passes
- [ ] Error responses flow through ErrorHandler

---

*Phase: 10-middleware-cross-cutting-concerns*
*Plan: 10-01*
*Created: 2026-01-12*
