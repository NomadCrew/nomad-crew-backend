---
phase: 17-domain-ssl-config
plan: 01
type: execute
---

<objective>
Configure custom domain and SSL certificates for production API deployment.

Purpose: Enable secure HTTPS access via api.nomadcrew.uk instead of raw IP address.
Output: Production API accessible at https://api.nomadcrew.uk with valid SSL certificate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/16-application-deployment/16-01-SUMMARY.md

**Current State:**
- Application running at: http://3.130.209.141:8081
- Coolify Dashboard: http://3.130.209.141:8000
- Health checks passing
- All external services connected

**Key Decisions from Phase 16:**
- Port 8081:8080 mapping to avoid Coolify conflict
- DNS only (gray cloud) in Cloudflare for Let's Encrypt compatibility
- Coolify GitHub App for auto-deploy

**Configuration:**
- CORS via `ALLOWED_ORIGINS` env var (currently `*`)
- Coolify uses Traefik for reverse proxy and SSL
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure DNS A record in Cloudflare for api.nomadcrew.uk</action>
  <instructions>
    1. Log in to Cloudflare dashboard (https://dash.cloudflare.com)
    2. Select the nomadcrew.uk domain
    3. Go to DNS settings
    4. Add new A record:
       - Name: `api`
       - IPv4 address: `3.130.209.141`
       - Proxy status: **DNS only (gray cloud)** - IMPORTANT for Let's Encrypt
       - TTL: Auto
    5. Save the record

    **Critical:** Must use DNS-only mode (gray cloud, not orange). Orange cloud (proxied) will interfere with Let's Encrypt HTTP-01 challenge.
  </instructions>
  <verification>Run `nslookup api.nomadcrew.uk` - should return 3.130.209.141</verification>
  <resume-signal>Type "done" when DNS record is configured and propagated</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure domain in Coolify and enable SSL</action>
  <instructions>
    1. Access Coolify dashboard at http://3.130.209.141:8000
    2. Navigate to the nomad-crew-backend application
    3. Go to the "Domain" or "Settings" section
    4. Set the domain to: `api.nomadcrew.uk`
    5. Ensure HTTPS is enabled (Coolify uses Let's Encrypt via Traefik)
    6. Port mapping should remain 8081:8080
    7. Save and apply changes
    8. Coolify will automatically:
       - Configure Traefik routing for the domain
       - Request Let's Encrypt SSL certificate
       - Set up HTTP to HTTPS redirect

    **Note:** SSL provisioning may take 1-2 minutes. Check Coolify logs if issues occur.
  </instructions>
  <verification>Coolify dashboard shows domain as active with SSL enabled</verification>
  <resume-signal>Type "done" when domain is configured and SSL is provisioned</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production API with SSL at https://api.nomadcrew.uk</what-built>
  <how-to-verify>
    1. Test HTTPS access:
       - Visit: https://api.nomadcrew.uk/health/liveness
       - Expected: `{"status":"ok"}` with 200 response

    2. Verify SSL certificate:
       - Click lock icon in browser
       - Confirm certificate is issued by Let's Encrypt
       - Confirm certificate is valid (not expired, matches domain)

    3. Test HTTP to HTTPS redirect:
       - Visit: http://api.nomadcrew.uk/health/liveness
       - Should automatically redirect to HTTPS

    4. Test full health check:
       - Visit: https://api.nomadcrew.uk/health
       - Should return status with database and redis connections

    5. Verify API endpoints:
       - Visit: https://api.nomadcrew.uk/api/v1/trips
       - Expected: 401 Unauthorized (correct - requires auth)

    6. Check no mixed content:
       - Open browser DevTools (F12)
       - Check Console tab for any mixed content warnings
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DNS A record configured and propagating (`nslookup api.nomadcrew.uk` returns 3.130.209.141)
- [ ] HTTPS accessible at https://api.nomadcrew.uk
- [ ] Valid Let's Encrypt SSL certificate installed
- [ ] HTTP to HTTPS redirect working
- [ ] Health endpoints responding correctly
- [ ] No mixed content warnings
</verification>

<success_criteria>

- api.nomadcrew.uk resolving to AWS EC2 IP
- Valid SSL certificate from Let's Encrypt
- HTTPS working with automatic redirect from HTTP
- All health checks passing via HTTPS
- API endpoints responding correctly (401 for unauth is expected)
</success_criteria>

<output>
After completion, create `.planning/phases/17-domain-ssl-config/17-01-SUMMARY.md`:

# Phase 17 Plan 01: Domain & SSL Configuration Summary

**[One-liner describing what was achieved]**

## Accomplishments

- [Key outcomes]

## Configuration Details

| Setting | Value |
|---------|-------|
| Domain | api.nomadcrew.uk |
| SSL Provider | Let's Encrypt |
| Certificate Expiry | [date] |

## Decisions Made

[Any decisions during execution]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 18: Monitoring Setup
</output>
