---
phase: 07-todo-domain-refactoring
plan: 01
type: execute
---

<objective>
Standardize todo handler to use established codebase patterns from Phase 1 refactoring.

Purpose: Ensure consistent code patterns across all handlers, improving maintainability and reducing duplication.
Output: Refactored todo_handler.go with standardized helper usage and error handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase patterns:
@.planning/phases/01-trip-domain-handler-refactoring/1-01-SUMMARY.md

# Source files:
@handlers/todo_handler.go
@handlers/trip_handler.go

# Key context:
**Tech stack available:** Go, Gin, SQLC
**Established patterns from Phase 1:**
- `bindJSONOrError(c, &obj)` - JSON binding with automatic error response
- `getUserIDFromContext(c)` - Extract user ID from Gin context
- Consistent `c.Error()` usage for error middleware handling

**Analysis findings:**
- Todo authorization is ALREADY correctly implemented in models/todo.go
- Todo store is clean with SQLC - no changes needed
- Handler needs standardization to match trip_handler.go patterns
- Routes are active with proper RBAC middleware

**What NOT to change:**
- models/todo.go - Business logic and authorization are correct
- todo_store.go - SQLC implementation is clean
- types/todo.go - Type definitions are complete
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply helper patterns to CreateTodoHandler and UpdateTodoHandler</name>
  <files>handlers/todo_handler.go</files>
  <action>
Refactor CreateTodoHandler (lines 52-105) and UpdateTodoHandler (lines 125-162):

1. Replace manual JSON binding with `bindJSONOrError`:
   - Change `if err := c.ShouldBindJSON(&req); err != nil { ... }`
   - To `if !bindJSONOrError(c, &req) { return }`

2. Replace manual userID extraction with `getUserIDFromContext`:
   - Change `userID := c.GetString(string(middleware.UserIDKey))`
   - To `userID := getUserIDFromContext(c)`

3. Standardize unauthorized response:
   - Change `c.JSON(http.StatusUnauthorized, gin.H{"error": "User not authenticated"})`
   - To `_ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated"))`
   - Import errors package if needed

4. Remove redundant logger.GetLogger() calls at start of each handler - the error helper functions already handle logging.

Note: The helper functions `bindJSONOrError` and `getUserIDFromContext` are already defined in trip_handler.go at package level and can be reused.
  </action>
  <verify>go build ./handlers/... compiles without errors</verify>
  <done>CreateTodoHandler and UpdateTodoHandler use bindJSONOrError, getUserIDFromContext, and c.Error() patterns</done>
</task>

<task type="auto">
  <name>Task 2: Apply helper patterns to remaining handlers</name>
  <files>handlers/todo_handler.go</files>
  <action>
Refactor DeleteTodoHandler (lines 181-210), ListTodosHandler (lines 248-276), and GetTodoHandler (lines 295-316):

1. Replace manual userID extraction in DeleteTodoHandler and ListTodosHandler:
   - Change `userID := c.GetString(string(middleware.UserIDKey))`
   - To `userID := getUserIDFromContext(c)`

2. Standardize unauthorized responses:
   - Change `c.JSON(http.StatusUnauthorized, gin.H{"error": "User not authenticated"})`
   - To `_ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated")); return`

3. Standardize validation error responses:
   - Change `c.JSON(http.StatusBadRequest, gin.H{"error": "Trip ID is required"})`
   - To `_ = c.Error(errors.ValidationFailed("missing_trip_id", "trip ID is required")); return`

4. Remove redundant `log := logger.GetLogger()` calls - errors flow through c.Error() to error middleware.

5. Simplify GetTodoHandler - it only needs validation, no auth check (RBAC middleware handles trip membership).
  </action>
  <verify>go build ./handlers/... compiles without errors</verify>
  <done>All todo handlers use consistent helper patterns and c.Error() for error handling</done>
</task>

<task type="auto">
  <name>Task 3: Verify complete refactoring and run tests</name>
  <files>handlers/todo_handler.go</files>
  <action>
1. Review the refactored todo_handler.go for consistency:
   - All handlers use getUserIDFromContext where needed
   - All JSON binding uses bindJSONOrError
   - All errors use c.Error() with appropriate error types
   - No redundant logger.GetLogger() calls at handler entry
   - getPaginationParams helper is retained (it's already a good pattern)

2. Build and test:
   - Run `go build ./...` to ensure full build passes
   - Run `go test ./handlers/...` to ensure handler tests pass (if they exist)

3. Verify error types are imported correctly:
   - Import `apperrors "github.com/NomadCrew/nomad-crew-backend/errors"` if using errors.Unauthorized, etc.
  </action>
  <verify>go build ./... && go test ./handlers/... 2>/dev/null || go build ./...</verify>
  <done>Todo handler fully refactored, builds clean, tests pass (if exist)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./handlers/...` succeeds without errors
- [ ] All todo handlers use `getUserIDFromContext` pattern
- [ ] All JSON binding uses `bindJSONOrError` pattern
- [ ] All error responses use `c.Error()` pattern
- [ ] No regression in functionality (handlers still work correctly)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Handler code is consistent with trip_handler.go patterns
- Code duplication reduced
</success_criteria>

<output>
After completion, create `.planning/phases/07-todo-domain-refactoring/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Handler Standardization Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `handlers/todo_handler.go` - Description of changes

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 8 (Chat Domain Refactoring)
</output>
