---
phase: 05-location-domain-refactoring
plan: 01
type: execute
---

<objective>
Consolidate duplicate location handlers and standardize error handling patterns.

Purpose: The location domain has 3 different handlers with overlapping functionality and inconsistent patterns. Consolidation reduces complexity and ensures consistent authorization.
Output: Single consolidated location handler following established Phase 1-4 patterns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-domain-refactoring/4-01-SUMMARY.md
@.planning/phases/04-user-domain-refactoring/4-02-SUMMARY.md

# Key files to reference:
@handlers/location_handler.go
@handlers/location_handler_supabase.go
@internal/handlers/location.go
@handlers/trip_handler.go (for established patterns)

**Established patterns from prior phases:**
- `bindJSONOrError` helper for request binding (Phase 1)
- `getUserIDFromContext` helper (Phase 1)
- AppError-based error handling with `errors.As` (Phase 1-4)
- Consistent 401/400/403/500 response patterns

**Issues being addressed:**
- 3 duplicate location handlers with overlapping functionality
- Inconsistent error response formats
- Missing authorization checks in `internal/handlers/location.go`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and document current handler usage</name>
  <files>handlers/location_handler.go, handlers/location_handler_supabase.go, internal/handlers/location.go, router/router.go</files>
  <action>
Examine router.go to determine which handlers are actually wired to routes. Document:
1. Which handler methods are registered to which routes
2. Which handlers are unused/dead code
3. The Supabase handler has helper methods (validateLocationData, validateTripAccess, etc.) that should be preserved
4. The internal/handlers/location.go bypasses service layer and has NO authorization - this is a security gap

Add deprecation comments to any handlers that will be removed:
```go
// Deprecated: [MethodName] is deprecated and will be removed. Use [NewMethod] instead.
```

Do NOT delete code yet - just document and mark deprecated. This ensures we don't break anything.
  </action>
  <verify>
Run `go build ./...` to ensure no syntax errors.
Grep for "Deprecated:" comments to confirm they were added.
  </verify>
  <done>
- Router.go analyzed and documented in code comments
- Unused handlers marked with Deprecated: prefix
- No build errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Standardize location_handler.go error handling</name>
  <files>handlers/location_handler.go</files>
  <action>
Refactor handlers/location_handler.go to follow Phase 1-4 patterns:

1. **Add helper functions** at top of file (like trip_handler.go):
```go
// bindJSONOrError binds JSON and returns true on success, false on error (already responded)
func (h *LocationHandler) bindJSONOrError(c *gin.Context, obj interface{}) bool {
    if err := c.ShouldBindJSON(obj); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request format: " + err.Error()})
        return false
    }
    return true
}

// getUserIDOrError gets user ID from context, returns empty string and responds on error
func (h *LocationHandler) getUserIDOrError(c *gin.Context) string {
    userID := c.GetString(string(middleware.UserIDKey))
    if userID == "" {
        c.JSON(http.StatusUnauthorized, gin.H{"error": "User not authenticated"})
        return ""
    }
    return userID
}
```

2. **Refactor UpdateLocationHandler** to use helpers:
- Replace manual JSON binding with bindJSONOrError
- Replace manual userID extraction with getUserIDOrError
- Use consistent AppError handling pattern with errors.As

3. **Refactor GetTripMemberLocationsHandler**:
- Same helper usage
- The 24-hour filter logic is business logic that belongs in the service, but for now leave it (out of scope for this phase)

4. **Remove UpdateLocationSupabase and GetTripMemberLocationsSupabase** - these are duplicate methods in the same file that call Supabase directly. The Supabase integration should be handled by location_handler_supabase.go exclusively.

Do NOT modify location_handler_supabase.go - it has good patterns and is used for Supabase realtime.
  </action>
  <verify>
Run `go build ./...` - no compilation errors
Run `go test ./handlers/... -run Location -v` - if tests exist, they should pass
  </verify>
  <done>
- location_handler.go uses bindJSONOrError and getUserIDOrError helpers
- Duplicate Supabase methods removed from location_handler.go
- Consistent error handling with AppError pattern
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] Deprecated comments added to unused handlers
- [ ] location_handler.go follows established patterns
- [ ] No duplicate method names between handlers
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Handler consolidation documented
- Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-location-domain-refactoring/05-01-SUMMARY.md`
</output>
