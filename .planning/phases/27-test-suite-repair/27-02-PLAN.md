---
phase: 27-test-suite-repair
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - handlers/mocks_test.go
  - handlers/user_handler_test.go
  - handlers/trip_handler_test.go
  - middleware/auth_test.go
  - middleware/jwt_validator_test.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "handlers package compiles without duplicate declaration errors"
    - "middleware package compiles without interface mismatch errors"
    - "All mocks implement their full interfaces"
  artifacts:
    - path: "handlers/mocks_test.go"
      provides: "Canonical mock definitions for handlers package"
      min_lines: 50
    - path: "middleware/auth_test.go"
      provides: "MockJWTValidator with ValidateAndGetClaims method"
      contains: "ValidateAndGetClaims"
  key_links:
    - from: "handlers/mocks_test.go"
      to: "types.UserServiceInterface"
      via: "interface assertion"
      pattern: "var _ .*UserService.* = .*MockUserService"
    - from: "middleware/auth_test.go"
      to: "middleware.Validator"
      via: "interface assertion"
      pattern: "var _ Validator = .*MockJWTValidator"
---

<objective>
Consolidate duplicate mocks and fix interface mismatches in handlers and middleware packages.

Purpose: Eliminate duplicate MockUserService declarations and add missing interface methods to mocks.
Output: handlers and middleware packages compile; all mocks implement their full interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-test-suite-repair/27-RESEARCH.md
@handlers/user_handler_test.go
@handlers/trip_handler_test.go
@middleware/auth_test.go
@middleware/jwt_validator_test.go
@middleware/jwt_validator.go (for Validator interface definition)
@types/user.go (for UserServiceInterface if defined)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consolidated handlers/mocks_test.go</name>
  <files>handlers/mocks_test.go</files>
  <action>
Create a new file `handlers/mocks_test.go` that contains ALL shared mocks for the handlers package. This eliminates duplicate declarations.

**File contents:**
```go
package handlers

import (
    "context"

    "github.com/NomadCrew/nomad-crew-backend/types"
    "github.com/stretchr/testify/mock"
)

// MockUserService implements the user service interface for handler tests.
// This is the CANONICAL definition - do not redeclare in other test files.
type MockUserService struct {
    mock.Mock
}

// Implement ALL methods from the user service interface.
// Check the actual interface in services/user_service.go or types/user.go.

func (m *MockUserService) CreateUser(ctx context.Context, user *types.User) (*types.User, error) {
    args := m.Called(ctx, user)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}

func (m *MockUserService) GetUserByID(ctx context.Context, id string) (*types.User, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}

func (m *MockUserService) GetUserBySupabaseID(ctx context.Context, supabaseID string) (*types.User, error) {
    args := m.Called(ctx, supabaseID)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}

func (m *MockUserService) GetUserByEmail(ctx context.Context, email string) (*types.User, error) {
    args := m.Called(ctx, email)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}

func (m *MockUserService) UpdateUser(ctx context.Context, id string, update *types.UserUpdate) (*types.User, error) {
    args := m.Called(ctx, id, update)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}

func (m *MockUserService) ListUsers(ctx context.Context, pagination *types.Pagination) (*types.UserListResponse, error) {
    args := m.Called(ctx, pagination)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.UserListResponse), args.Error(1)
}

// Add any other methods required by the UserServiceInterface.
// Use interface assertion to catch missing methods at compile time:
// var _ UserServiceInterface = (*MockUserService)(nil)
```

**Important:** Review the actual UserServiceInterface (check handlers package imports or types package) and implement ALL methods. The above is based on research - verify against actual interface.
  </action>
  <verify>File exists and has mock definitions</verify>
  <done>handlers/mocks_test.go contains canonical MockUserService with all interface methods</done>
</task>

<task type="auto">
  <name>Task 2: Remove duplicate mocks from handler test files</name>
  <files>handlers/user_handler_test.go, handlers/trip_handler_test.go</files>
  <action>
**From handlers/user_handler_test.go:**
- DELETE the MockUserService struct definition (line 20)
- DELETE all MockUserService method implementations (lines 42-92 approximately)
- KEEP the test functions that USE MockUserService

**From handlers/trip_handler_test.go:**
- DELETE the MockUserService struct definition (line 135)
- DELETE all MockUserService method implementations (lines 139-184 approximately)
- KEEP MockTripModel, MockEventPublisher, MockWeatherService, MockPexelsClient (these are unique to this file)
- KEEP the test functions that USE these mocks

**After removal:** Both files should import mocks from the same-package mocks_test.go (no import needed since same package).

**Verify no duplicates:**
```bash
grep -n "type MockUserService struct" handlers/*_test.go
```
Should return exactly 1 result (in mocks_test.go only).
  </action>
  <verify>
```bash
grep -c "type MockUserService struct" handlers/*_test.go | grep -v ":1$" | grep -v ":0$"
```
Should return nothing (each file has 0 or 1 declaration, with exactly 1 total in mocks_test.go).
  </verify>
  <done>MockUserService declared exactly once in handlers/mocks_test.go</done>
</task>

<task type="auto">
  <name>Task 3: Fix MockJWTValidator and TestJWTValidator interface mismatches</name>
  <files>middleware/auth_test.go, middleware/jwt_validator_test.go</files>
  <action>
**The Validator interface (from middleware/jwt_validator.go lines 32-35):**
```go
type Validator interface {
    Validate(tokenString string) (string, error)
    ValidateAndGetClaims(tokenString string) (*types.JWTClaims, error)
}
```

**Fix middleware/auth_test.go - MockJWTValidator:**
Add the missing ValidateAndGetClaims method:

```go
// Add this method to MockJWTValidator (after line 26):
func (m *MockJWTValidator) ValidateAndGetClaims(tokenString string) (*types.JWTClaims, error) {
    args := m.Called(tokenString)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.JWTClaims), args.Error(1)
}
```

**Fix middleware/jwt_validator_test.go - TestJWTValidator:**
Find TestJWTValidator struct and add the missing method:

```go
func (v *TestJWTValidator) ValidateAndGetClaims(tokenString string) (*types.JWTClaims, error) {
    // Return test claims or delegate to existing logic
    userID, err := v.Validate(tokenString)
    if err != nil {
        return nil, err
    }
    return &types.JWTClaims{UserID: userID}, nil
}
```

**Ensure interface assertions compile:**
The existing `var _ Validator = (*MockJWTValidator)(nil)` (line 29) should now pass.
  </action>
  <verify>
```bash
go build ./middleware/... 2>&1 | grep -i "does not implement Validator"
```
Should return nothing (no interface mismatch errors).
  </verify>
  <done>
- MockJWTValidator implements Validate and ValidateAndGetClaims
- TestJWTValidator implements Validate and ValidateAndGetClaims
- Interface assertions pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **No duplicate mocks:**
   ```bash
   grep -rn "type MockUserService struct" handlers/
   ```
   Returns exactly 1 result in mocks_test.go.

2. **Interface assertions pass:**
   ```bash
   go build ./handlers/... ./middleware/... 2>&1 | grep "does not implement"
   ```
   Returns nothing.

3. **Packages compile:**
   ```bash
   go test -c ./handlers/... 2>&1 | grep -E "FAIL|redeclared"
   go test -c ./middleware/... 2>&1 | grep -E "FAIL|does not implement"
   ```
   Both return nothing or only non-interface/non-duplicate errors.
</verification>

<success_criteria>
- [ ] handlers/mocks_test.go exists with canonical MockUserService
- [ ] No duplicate MockUserService declarations in handlers package
- [ ] MockJWTValidator has ValidateAndGetClaims method
- [ ] TestJWTValidator has ValidateAndGetClaims method
- [ ] handlers and middleware packages compile (may have other errors fixed in Plan 03/04)
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-02-SUMMARY.md`
</output>
