---
phase: 27-test-suite-repair
plan: 03
type: execute
wave: 2
depends_on: [27-01, 27-02]
files_modified:
  - handlers/trip_handler_test.go
  - models/user/service/user_service_test.go
  - models/trip/service/trip_service_notification_test.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "handlers package compiles without undefined type errors"
    - "models/user/service package compiles without interface mismatch errors"
    - "models/trip/service package compiles without constructor argument errors"
  artifacts:
    - path: "handlers/trip_handler_test.go"
      provides: "Complete MockTripModel with AddMember method"
      contains: "func (m *MockTripModel) AddMember"
    - path: "models/user/service/user_service_test.go"
      provides: "MockUserStore with GetUserByContactEmail method"
      contains: "func (m *MockUserStore) GetUserByContactEmail"
  key_links:
    - from: "handlers/trip_handler_test.go"
      to: "interfaces.TripModelInterface"
      via: "interface assertion"
      pattern: "var _ interfaces.TripModelInterface = .*MockTripModel"
    - from: "models/user/service/user_service_test.go"
      to: "store.UserStore"
      via: "interface assertion"
      pattern: "var _ .*UserStore = .*MockUserStore"
---

<objective>
Fix remaining interface mismatches and type errors in handlers and models packages.

Purpose: Resolve MockTripModel, MockUserStore interface gaps; fix undefined types.
Output: handlers, models/user/service, and models/trip/service packages compile.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-test-suite-repair/27-RESEARCH.md
@.planning/phases/27-test-suite-repair/27-02-SUMMARY.md
@handlers/trip_handler_test.go
@models/user/service/user_service_test.go
@models/trip/service/trip_service_notification_test.go
@internal/store/user_store.go (for UserStore interface)
@models/trip/service/trip_service.go (for constructor signature)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix MockTripModel interface and undefined types in handlers</name>
  <files>handlers/trip_handler_test.go</files>
  <action>
**Depends on Plan 27-02:** This plan runs after 27-02 which creates handlers/mocks_test.go and removes duplicate MockUserService. The MockTripModel in trip_handler_test.go is separate and handled here.

**1. Add missing AddMember method to MockTripModel:**

Find the MockTripModel struct (line 28) and add:

```go
func (m *MockTripModel) AddMember(ctx context.Context, tripID, userID string, role types.MemberRole) error {
    args := m.Called(ctx, tripID, userID, role)
    return args.Error(0)
}
```

Check interfaces.TripModelInterface for any other missing methods and add them.

**2. Fix undefined types.WeatherForecast (line 127):**

Check if types.WeatherForecast exists in types/ package. If not:
- Option A: Define it in types/weather.go
- Option B: Use the correct type name (might be renamed)
- Option C: If MockWeatherService doesn't need this return type, simplify the mock

**3. Fix undefined types.UserUpdate (line 171):**

Check if types.UserUpdate exists. It likely does - verify the import path. If the mock method signature is wrong, fix it to match the actual interface.

**4. Add interface assertion:**

```go
var _ interfaces.TripModelInterface = (*MockTripModel)(nil)
```

This ensures the compiler catches any missing methods.
  </action>
  <verify>
```bash
go build ./handlers/... 2>&1 | grep -E "undefined:|does not implement"
```
Should return nothing.
  </verify>
  <done>
- MockTripModel implements AddMember and all other TripModelInterface methods
- types.WeatherForecast and types.UserUpdate references resolved
- Interface assertion compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix MockUserStore interface mismatch in models/user/service</name>
  <files>models/user/service/user_service_test.go</files>
  <action>
**Add missing GetUserByContactEmail method to MockUserStore:**

Find the MockUserStore struct in the test file and add:

```go
func (m *MockUserStore) GetUserByContactEmail(ctx context.Context, email string) (*types.User, error) {
    args := m.Called(ctx, email)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*types.User), args.Error(1)
}
```

**Check the full UserStore interface** in internal/store/user_store.go (or wherever it's defined) and ensure MockUserStore implements ALL methods:

Common methods to check:
- GetUserByID
- GetUserBySupabaseID
- GetUserByEmail
- GetUserByContactEmail (the one missing)
- CreateUser
- UpdateUser
- DeleteUser
- ListUsers

**Add interface assertion:**

```go
import "github.com/NomadCrew/nomad-crew-backend/internal/store"

var _ store.UserStore = (*MockUserStore)(nil)
```
  </action>
  <verify>
```bash
go build ./models/user/service/... 2>&1 | grep "does not implement"
```
Should return nothing.
  </verify>
  <done>MockUserStore implements GetUserByContactEmail and all other UserStore methods</done>
</task>

<task type="auto">
  <name>Task 3: Fix trip_service_notification_test.go constructor and type errors</name>
  <files>models/trip/service/trip_service_notification_test.go</files>
  <action>
**Multiple issues to fix:**

**1. Undefined mocks.UserStore (lines 71, 138, 218):**

Check where UserStore mock is defined. Options:
- Import from internal/store/mocks if it exists there
- Create a local mock in the test file
- Use the existing mock from a different location

```go
// If creating locally:
type MockUserStore struct {
    mock.Mock
}
// ... implement methods
```

Or if it exists elsewhere:
```go
import "github.com/NomadCrew/nomad-crew-backend/internal/store/mocks"
// Use mocks.UserStore
```

**2. Constructor argument mismatch (lines 83, 149):**

Check the actual NewTripManagementService signature in models/trip/service/trip_service.go.

Current call has 6 arguments, but constructor expects 5:
```go
// WRONG (6 args):
tripservice.NewTripManagementService(tripStore, userStore, eventPublisher, weatherService, nil, notificationService)

// Check actual signature - likely one of:
tripservice.NewTripManagementService(tripStore, userStore, eventPublisher, weatherService, supabaseService)
```

Update the test to match the actual constructor signature.

**3. Fix *string vs string mismatches (lines 98, 158, 170):**

If the struct field expects string but test uses *string:
```go
// WRONG:
Description: ptr("A test trip")

// CORRECT (if field is string):
Description: "A test trip"
```

Or if field really is *string, ensure ptr() helper exists:
```go
func ptr(s string) *string { return &s }
```

**4. Add missing reflect import (lines 88, 91):**

If the test uses reflection:
```go
import "reflect"
```
  </action>
  <verify>
```bash
go build ./models/trip/service/... 2>&1 | grep -E "undefined|too many arguments|cannot use"
```
Should return nothing.
  </verify>
  <done>
- UserStore mock available and properly imported
- Constructor calls match actual signature
- String/pointer types match struct definitions
- All imports present
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **handlers compiles:**
   ```bash
   go test -c ./handlers/... 2>&1 | grep "FAIL"
   ```
   Returns nothing.

2. **models packages compile:**
   ```bash
   go test -c ./models/user/service/... ./models/trip/service/... 2>&1 | grep "FAIL"
   ```
   Returns nothing.
</verification>

<success_criteria>
- [ ] MockTripModel implements all TripModelInterface methods including AddMember
- [ ] MockUserStore implements all UserStore methods including GetUserByContactEmail
- [ ] trip_service_notification_test.go compiles (correct constructor args, types, imports)
- [ ] handlers, models/user/service, models/trip/service packages compile
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-03-SUMMARY.md`
</output>
