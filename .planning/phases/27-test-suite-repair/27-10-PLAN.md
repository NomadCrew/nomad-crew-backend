---
phase: 27-test-suite-repair
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - store/postgres/trip_store_pg_mock_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "store/postgres package compiles without errors"
    - "Tests use current types.Trip, TripMembership, TripInvitation structs"
  artifacts:
    - path: "store/postgres/trip_store_pg_mock_test.go"
      provides: "Trip store tests using current type definitions"
  key_links:
    - from: "store/postgres/trip_store_pg_mock_test.go"
      to: "types/trip.go"
      via: "Trip struct"
      pattern: "types\\.Trip"
---

<objective>
Fix store/postgres package test compilation by updating to current type definitions.

Purpose: trip_store_pg_mock_test.go references fields that have been removed or renamed in the Trip, TripMembership, and TripInvitation structs.
Output: Compilable store postgres tests using current type definitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@store/postgres/trip_store_pg_mock_test.go
@types/trip.go
@types/membership.go
@types/invitation.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Trip struct usage in tests</name>
  <files>store/postgres/trip_store_pg_mock_test.go</files>
  <action>
**Issue 1: Trip.IsDeleted doesn't exist (line 31, 145)**
The types.Trip struct uses `DeletedAt *time.Time` instead of `IsDeleted bool`.

Current Trip struct (from types/trip.go):
- ID, Name, Description
- DestinationPlaceID, DestinationAddress, DestinationName
- DestinationLatitude, DestinationLongitude
- StartDate, EndDate
- Status (TripStatus)
- CreatedBy (*string)
- CreatedAt, UpdatedAt
- DeletedAt (*time.Time)  // NOT IsDeleted bool
- BackgroundImageURL

Update createTestTrip() helper function (around line 20-33):
```go
func createTestTrip() types.Trip {
    createdBy := uuid.NewString()
    return types.Trip{
        ID:          uuid.NewString(),
        Name:        "Test Trip",
        Description: "Test trip description",
        StartDate:   time.Now().Add(24 * time.Hour),
        EndDate:     time.Now().Add(7 * 24 * time.Hour),
        CreatedBy:   &createdBy,
        CreatedAt:   time.Now(),
        UpdatedAt:   time.Now(),
        // Remove: IsDeleted: false,
        // DeletedAt is nil by default (not deleted)
    }
}
```

Remove line 31: `IsDeleted: false,`

For line 145 (trip.IsDeleted reference in test), change to:
- Use `trip.DeletedAt == nil` for "not deleted" check
- Or simply remove the assertion if it's not essential
  </action>
  <verify>Trip struct fields match types/trip.go definition</verify>
  <done>Trip struct usage updated to match current definition</done>
</task>

<task type="auto">
  <name>Task 2: Update TripMembership struct usage</name>
  <files>store/postgres/trip_store_pg_mock_test.go</files>
  <action>
**Issue: TripMembership.JoinedAt doesn't exist (line 41)**

Current TripMembership struct (from types/membership.go):
- ID, TripID, UserID
- Role (MemberRole)
- Status (MembershipStatus)
- CreatedAt, UpdatedAt
- DeletedAt (*time.Time)

There is NO JoinedAt field - use CreatedAt instead.

Update createTestTripMembership() helper function:
```go
func createTestTripMembership() *types.TripMembership {
    return &types.TripMembership{
        TripID:    uuid.NewString(),
        UserID:    uuid.NewString(),
        Role:      types.MemberRoleMember,
        // Remove: JoinedAt: time.Now(),
        CreatedAt: time.Now(),  // Use CreatedAt instead of JoinedAt
    }
}
```

Remove line 41: `JoinedAt: time.Now(),`
Add: `CreatedAt: time.Now(),`
  </action>
  <verify>TripMembership struct fields match types/membership.go definition</verify>
  <done>TripMembership struct usage updated to match current definition</done>
</task>

<task type="auto">
  <name>Task 3: Update TripInvitation struct usage</name>
  <files>store/postgres/trip_store_pg_mock_test.go</files>
  <action>
**Issue: TripInvitation.Email and CreatedBy don't exist (lines 50, 53)**

Current TripInvitation struct (from types/invitation.go):
- ID, TripID
- InviterID (not CreatedBy)
- InviteeEmail (not Email)
- InviteeID (*string, optional)
- Role (MemberRole)
- Status (InvitationStatus)
- CreatedAt, UpdatedAt
- ExpiresAt (*time.Time)
- Token (sql.NullString)

Update createTestTripInvitation() helper function:
```go
func createTestTripInvitation() *types.TripInvitation {
    return &types.TripInvitation{
        ID:           uuid.NewString(),
        TripID:       uuid.NewString(),
        // Remove: Email: "invitee@example.com",
        InviteeEmail: "invitee@example.com",  // Correct field name
        Role:         types.MemberRoleMember,
        Status:       types.InvitationStatusPending,
        // Remove: CreatedBy: uuid.NewString(),
        InviterID:    uuid.NewString(),  // Correct field name
        CreatedAt:    time.Now(),
        UpdatedAt:    time.Now(),
    }
}
```

Changes:
- Line 50: `Email` -> `InviteeEmail`
- Line 53: `CreatedBy` -> `InviterID`
  </action>
  <verify>TripInvitation struct fields match types/invitation.go definition</verify>
  <done>TripInvitation struct usage updated to match current definition</done>
</task>

<task type="auto">
  <name>Task 4: Fix setupMockDB and unused variables</name>
  <files>store/postgres/trip_store_pg_mock_test.go</files>
  <action>
**Issue: setupMockDB is undefined (lines 60, 133)**
The test file uses `db, mock, cleanup := setupMockDB(t)` but setupMockDB is not defined in this package.

**Issue: db and ctx are declared and not used (lines 60, 63, 133)**

Options:
1. Copy setupMockDB from internal/store/postgres/user_store_mock_test.go
2. Define setupMockDB locally in this test file

Add setupMockDB function at the top of the file (after imports):
```go
func setupMockDB(t testing.TB) (*sql.DB, sqlmock.Sqlmock, func()) {
    db, mock, err := sqlmock.New()
    require.NoError(t, err)

    cleanup := func() {
        db.Close()
    }

    return db, mock, cleanup
}
```

Also fix the unused variable issues using blank identifiers:
- Change `db, mock, cleanup := setupMockDB(t)` to `_, mock, cleanup := setupMockDB(t)` where db is unused
- Change `ctx := context.Background()` to `_ = context.Background()` OR remove where unused

Apply to all test functions that have this pattern.
  </action>
  <verify>go test -c ./store/postgres/... compiles without errors</verify>
  <done>store/postgres package compiles without undefined or unused variable errors</done>
</task>

</tasks>

<verification>
```bash
# Verify store/postgres package compiles
go test -c ./store/postgres/...

# Run tests
go test -v ./store/postgres/...
```
</verification>

<success_criteria>
- store/postgres package compiles: `go test -c ./store/postgres/...` exits 0
- No "unknown field" errors for Trip, TripMembership, or TripInvitation
- No "undefined: setupMockDB" errors
- No "declared and not used" errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-10-SUMMARY.md`
</output>
