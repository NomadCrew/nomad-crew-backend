---
phase: 27-test-suite-repair
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - models/trip/service/mocks_test.go
  - models/trip/service/trip_service_test.go
  - models/trip/service/trip_service_notification_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "models/trip/service package compiles without errors"
    - "Single source of truth for MockWeatherService and MockUserStore"
  artifacts:
    - path: "models/trip/service/mocks_test.go"
      provides: "Consolidated mock definitions for trip service tests"
    - path: "models/trip/service/trip_service_test.go"
      provides: "Trip service tests without duplicate mocks"
    - path: "models/trip/service/trip_service_notification_test.go"
      provides: "Notification tests without duplicate mocks"
  key_links:
    - from: "models/trip/service/*_test.go"
      to: "models/trip/service/mocks_test.go"
      via: "shared mock types"
      pattern: "Mock(Weather|User)"
---

<objective>
Consolidate duplicate mock declarations in models/trip/service test files.

Purpose: MockWeatherService and MockUserStore are declared in both trip_service_test.go and trip_service_notification_test.go, causing redeclaration errors.
Output: Single source of truth for mocks in mocks_test.go with duplicate declarations removed from individual test files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@models/trip/service/trip_service_test.go
@models/trip/service/trip_service_notification_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consolidated mocks_test.go</name>
  <files>models/trip/service/mocks_test.go</files>
  <action>
Create a new file models/trip/service/mocks_test.go containing:

1. Package declaration: `package service_test`

2. All required imports

3. MockWeatherService - take the COMPLETE implementation from trip_service_test.go (lines 222-252):
   - StartWeatherUpdates
   - IncrementSubscribers
   - DecrementSubscribers
   - TriggerImmediateUpdate
   - GetWeather

4. MockUserStore - take the COMPLETE implementation from trip_service_test.go (lines 255-391):
   - GetUserByID
   - GetUserByEmail
   - GetUserBySupabaseID
   - CreateUser
   - UpdateUser
   - GetUserByUsername
   - ListUsers
   - SyncUserFromSupabase
   - GetSupabaseUser
   - ConvertToUserResponse
   - GetUserProfile
   - GetUserProfiles
   - UpdateLastSeen
   - SetOnlineStatus
   - UpdateUserPreferences
   - BeginTx
   - GetUserByContactEmail
   - SearchUsers
   - UpdateContactEmail

Ensure all method signatures match the interfaces in types package.
  </action>
  <verify>File exists and contains both MockWeatherService and MockUserStore</verify>
  <done>mocks_test.go created with consolidated mock definitions</done>
</task>

<task type="auto">
  <name>Task 2: Remove duplicate mocks from trip_service_test.go</name>
  <files>models/trip/service/trip_service_test.go</files>
  <action>
Remove the following duplicate declarations from trip_service_test.go:

1. Remove MockWeatherService struct and all its methods (lines ~222-252)
2. Remove MockUserStore struct and all its methods (lines ~255-391)

Keep all other mocks that are NOT duplicated:
- MockTransaction (lines ~24-36)
- MockTripStore (lines ~39-189)
- MockEventPublisher (lines ~192-219)
- TripServiceTestSuite and all test functions

After removal, the file should still compile because it will use the mocks from mocks_test.go (same package service_test).
  </action>
  <verify>trip_service_test.go no longer contains MockWeatherService or MockUserStore declarations</verify>
  <done>Duplicate mock declarations removed from trip_service_test.go</done>
</task>

<task type="auto">
  <name>Task 3: Remove duplicate mocks from trip_service_notification_test.go</name>
  <files>models/trip/service/trip_service_notification_test.go</files>
  <action>
Remove the following duplicate declarations from trip_service_notification_test.go:

1. Remove MockUserStore struct and all its methods (lines ~19-101)
2. Remove MockWeatherService struct and all its methods (lines ~104-131)
3. Remove MockNotificationService if it's not needed by other tests, OR keep it if it's unique to this file

Keep:
- All test functions (TestTripServiceNotifications, etc.)
- The ptr() helper function
- Any imports still needed

The file should continue to use MockUserStore and MockWeatherService from the consolidated mocks_test.go.
  </action>
  <verify>go test -c ./models/trip/service/... compiles without redeclaration errors</verify>
  <done>models/trip/service package compiles without duplicate declaration errors</done>
</task>

</tasks>

<verification>
```bash
# Verify models/trip/service package compiles
go test -c ./models/trip/service/...

# Run trip service tests
go test -v ./models/trip/service/...
```
</verification>

<success_criteria>
- models/trip/service package compiles: `go test -c ./models/trip/service/...` exits 0
- No "redeclared in this block" errors
- No "method already declared" errors
- All mock methods are available to both test files
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-07-SUMMARY.md`
</output>
