---
phase: 27-test-suite-repair
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - config/database_utils_test.go
  - db/db_client_test.go
  - services/health_service_test.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "go mod download succeeds with all test dependencies"
    - "No pgx/v4 imports remain in test files"
    - "All 5 blocking packages compile (config, db, services, store/postgres, internal/store/postgres)"
  artifacts:
    - path: "go.mod"
      provides: "Test dependency declarations"
      contains: "pashagolub/pgxmock/v4"
    - path: "go.mod"
      provides: "Redis mock dependency"
      contains: "go-redis/redismock/v9"
  key_links:
    - from: "config/database_utils_test.go"
      to: "pgxmock/v4"
      via: "import statement"
      pattern: "pashagolub/pgxmock/v4"
    - from: "db/db_client_test.go"
      to: "pgxmock/v4"
      via: "import statement"
      pattern: "pashagolub/pgxmock/v4"
---

<objective>
Install missing test dependencies and fix pgx v4/v5 import mismatch.

Purpose: Unblock 5 packages that fail to compile due to missing dependencies and wrong pgx version imports.
Output: All dependency-related compilation errors resolved; packages can proceed to interface/type fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-test-suite-repair/27-RESEARCH.md
@go.mod
@config/database_utils_test.go
@db/db_client_test.go
@services/health_service_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install missing test dependencies</name>
  <files>go.mod, go.sum</files>
  <action>
Run the following commands to add the missing test dependencies:

```bash
go get github.com/pashagolub/pgxmock/v4
go get github.com/go-redis/redismock/v9
go mod tidy
```

**Why pgxmock/v4:** The codebase uses pgx/v5 (jackc/pgx/v5). pgxmock/v4 is the official mocking library for pgx v5 (the version number is pgxmock's version, not pgx's).

**Why redismock/v9:** The codebase uses go-redis/v9. redismock/v9 is the matching mock library.

**Do NOT add:** go-sqlmock or pgx/v4. These are incompatible with the pgx v5 driver used in production code.
  </action>
  <verify>
```bash
go list -m github.com/pashagolub/pgxmock/v4
go list -m github.com/go-redis/redismock/v9
```
Both commands should return version info without errors.
  </verify>
  <done>pgxmock/v4 and redismock/v9 appear in go.mod require block</done>
</task>

<task type="auto">
  <name>Task 2: Fix pgx v4 imports in 3 test files</name>
  <files>config/database_utils_test.go, db/db_client_test.go, services/health_service_test.go</files>
  <action>
**For each file, replace pgx/v4 imports with pgx/v5 or pgxmock/v4:**

1. **config/database_utils_test.go** (line 10):
   - Change: `"github.com/jackc/pgx/v4/pgxpool"` -> `"github.com/jackc/pgx/v5/pgxpool"`
   - If file uses mock pool creation, switch to pgxmock pattern

2. **db/db_client_test.go** (line 11):
   - Change: `"github.com/jackc/pgx/v4/pgxpool"` -> `"github.com/jackc/pgx/v5/pgxpool"`
   - REMOVE: `"github.com/DATA-DOG/go-sqlmock"` import (incompatible with pgx)
   - ADD: `"github.com/pashagolub/pgxmock/v4"` for mocking

   **Concrete pgxmock replacement example for db/db_client_test.go:**

   Replace sqlmock usage:
   ```go
   // BEFORE (sqlmock - incompatible with pgx):
   import "github.com/DATA-DOG/go-sqlmock"

   func TestDBClient(t *testing.T) {
       db, mock, err := sqlmock.New()
       require.NoError(t, err)
       defer db.Close()

       mock.ExpectQuery("SELECT").WillReturnRows(...)
   }

   // AFTER (pgxmock - compatible with pgx v5):
   import "github.com/pashagolub/pgxmock/v4"

   func TestDBClient(t *testing.T) {
       mock, err := pgxmock.NewPool()
       require.NoError(t, err)
       defer mock.Close()

       // For Ping tests:
       mock.ExpectPing()

       // For Query tests:
       rows := pgxmock.NewRows([]string{"id", "name"}).
           AddRow(1, "test")
       mock.ExpectQuery("SELECT").WillReturnRows(rows)

       // Use mock as *pgxpool.Pool replacement
       // Pass mock to functions expecting Pool interface
   }
   ```

3. **services/health_service_test.go** (line 12):
   - Change: `"github.com/jackc/pgx/v4/pgxpool"` -> `"github.com/jackc/pgx/v5/pgxpool"`
   - File already imports pashagolub/pgxmock (line 13) - ensure it's v4: `"github.com/pashagolub/pgxmock/v4"`

**Do NOT:** Add pgx/v4 alongside v5 - this causes module confusion.
  </action>
  <verify>
```bash
grep -r "pgx/v4" config/ db/ services/ --include="*_test.go"
```
Should return no results (0 matches).
  </verify>
  <done>
- config/database_utils_test.go imports pgx/v5 only
- db/db_client_test.go imports pgx/v5 and pgxmock/v4 (no sqlmock)
- services/health_service_test.go imports pgx/v5 and pgxmock/v4
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify dependency fix compilation</name>
  <files>None (verification only)</files>
  <action>
Run targeted compilation tests to verify the 5 blocking packages now compile:

```bash
go test -c ./config/... 2>&1 || echo "config FAILED"
go test -c ./db/... 2>&1 || echo "db FAILED"
go test -c ./services/... 2>&1 || echo "services FAILED"
```

If any package still fails due to import issues, fix the remaining import statements.

**Expected remaining failures:** These packages may still have interface/type errors (fixed in Plan 02), but should NOT have "no required module provides package" errors.
  </action>
  <verify>
```bash
go test ./config/... ./db/... ./services/... 2>&1 | grep -E "no required module|FAIL.*setup failed" | wc -l
```
Should return 0 (no missing module errors).
  </verify>
  <done>config, db, and services packages compile without missing dependency errors</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Dependency check:**
   ```bash
   go list -m github.com/pashagolub/pgxmock/v4
   go list -m github.com/go-redis/redismock/v9
   ```
   Both return valid versions.

2. **No v4 imports:**
   ```bash
   grep -r "pgx/v4" --include="*_test.go" .
   ```
   Returns 0 results (internal/store/postgres files fixed in Plan 03).

3. **Compilation progress:**
   ```bash
   go test ./... 2>&1 | grep "setup failed" | wc -l
   ```
   Should be reduced from 5 to 2 or less (remaining: internal/store/postgres, store/postgres which need more extensive sqlmock->pgxmock migration in Plan 03).
</verification>

<success_criteria>
- [ ] pgxmock/v4 in go.mod require block
- [ ] redismock/v9 in go.mod require block
- [ ] No pgx/v4 imports in config/, db/, services/ test files
- [ ] config, db, services packages compile (may have test failures, but no setup failures)
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-01-SUMMARY.md`
</output>
