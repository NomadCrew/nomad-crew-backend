---
phase: 27-test-suite-repair
plan: 04
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - internal/auth/jwt_test.go
  - internal/auth/config_validator_test.go
  - internal/notification/client_test.go
  - tests/integration/invitation_integration_test.go
  - internal/store/postgres/user_store_mock_test.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "internal/auth package compiles without jwt.Parser.Parts errors"
    - "internal/notification tests pass (pagination assertion fixed)"
    - "tests/integration compiles (LocationHandler field removed)"
    - "All packages compile with go test ./..."
  artifacts:
    - path: "internal/auth/jwt_test.go"
      provides: "JWT parsing tests without deprecated Parts() method"
      contains: "strings.Split"
  key_links:
    - from: "internal/auth/jwt_test.go"
      to: "strings package"
      via: "import and Split call"
      pattern: 'strings\.Split.*"\."'
---

<objective>
Fix remaining type errors, API changes, and test logic issues to achieve full compilation.

Purpose: Resolve jwt.Parser.Parts() API change, fix test assertions, remove invalid struct fields.
Output: All 22 packages compile; go test ./... runs without compilation errors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-test-suite-repair/27-RESEARCH.md
@internal/auth/jwt_test.go
@internal/auth/config_validator_test.go
@internal/notification/client_test.go
@tests/integration/invitation_integration_test.go
@internal/store/postgres/user_store_mock_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix jwt.Parser.Parts() API in internal/auth</name>
  <files>internal/auth/jwt_test.go, internal/auth/config_validator_test.go</files>
  <action>
**jwt_test.go - Replace jwt.Parser.Parts() (lines 79, 260):**

The jwt/v5 library removed the `Parts()` method. JWT tokens are period-separated base64 strings, so use strings.Split directly:

```go
// BEFORE (doesn't compile):
parts, err := jwt.NewParser().Parts(token)

// AFTER:
parts := strings.Split(token, ".")
if len(parts) != 3 {
    // handle invalid token format
}
// parts[0] = header, parts[1] = payload, parts[2] = signature
```

Add import if not present:
```go
import "strings"
```

**jwt_test.go - Fix unused variable (line 456):**
```go
// BEFORE:
for i, tc := range testCases {
    // i is not used
}

// AFTER (if i is truly unused):
for _, tc := range testCases {
    // ...
}
```

**config_validator_test.go - Fix unused import (line 12):**
```go
// BEFORE:
import "github.com/stretchr/testify/require"
// (but require is never used)

// AFTER - either:
// 1. Remove the import if truly unused
// 2. Or use require somewhere in the tests
```

Check if require is used anywhere in the file. If not, remove the import.
  </action>
  <verify>
```bash
go build ./internal/auth/... 2>&1 | grep -E "undefined|declared and not used|imported and not used"
```
Should return nothing.
  </verify>
  <done>
- jwt.NewParser().Parts() replaced with strings.Split()
- Unused variable i removed or used
- Unused require import removed or used
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix test logic errors</name>
  <files>internal/notification/client_test.go, tests/integration/invitation_integration_test.go</files>
  <action>
**1. Fix pagination assertion in internal/notification/client_test.go (line 636):**

The test expects limit=10, but API returns limit=20. Determine which is correct:

Option A - If 20 is the correct default:
```go
// Update assertion from:
assert.Equal(t, "10", response.Limit)
// To:
assert.Equal(t, "20", response.Limit)
```

Option B - If 10 should be the default, the API has a bug (out of scope for this phase).

**Check the API code** to determine the correct default pagination limit. Update the test assertion to match the actual implementation.

**2. Fix unknown field in tests/integration/invitation_integration_test.go (line 318):**

Remove or fix the LocationHandler field reference:

```go
// BEFORE:
deps := router.Dependencies{
    // ...
    LocationHandler: locationHandler,  // This field doesn't exist
    // ...
}

// AFTER (remove the line):
deps := router.Dependencies{
    // ...
    // LocationHandler removed - field doesn't exist in Dependencies struct
    // ...
}
```

Check `router/router.go` for the actual Dependencies struct definition and ensure the test uses only valid fields.
  </action>
  <verify>
```bash
go test ./internal/notification/... -v -run TestGetUserNotifications/with_pagination 2>&1 | grep -E "PASS|FAIL"
go build ./tests/integration/... 2>&1 | grep "unknown field"
```
First should show PASS, second should return nothing.
  </verify>
  <done>
- Pagination assertion matches actual API behavior
- LocationHandler field removed from Dependencies struct literal
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix internal/store/postgres pgx v4 imports</name>
  <files>internal/store/postgres/user_store_mock_test.go</files>
  <action>
**Fix pgx v4 imports (lines 18-19):**

```go
// BEFORE:
import (
    "github.com/jackc/pgx/v4"
    "github.com/jackc/pgx/v4/pgxpool"
)

// AFTER:
import (
    "github.com/jackc/pgx/v5"
    "github.com/jackc/pgx/v5/pgxpool"
)
```

**Note on sqlmock:** The internal/store/postgres tests use DATA-DOG/go-sqlmock extensively. A full migration to pgxmock is OUT OF SCOPE for this phase because:
1. These tests use database/sql patterns, not pgx patterns
2. The migration would require significant rewrite
3. The tests may still work if sqlmock is added (they're testing through sql.DB interface)

**Decision point:** If these tests MUST use pgx driver directly:
- Rewrite to use pgxmock (significant effort)

If they can work through database/sql (lib/pq):
- Add go-sqlmock dependency: `go get github.com/DATA-DOG/go-sqlmock`
- Keep tests as-is

For this plan, focus on pgx import fixes. If sqlmock is needed, add it as a dev dependency.
  </action>
  <verify>
```bash
grep -r "pgx/v4" internal/store/postgres/ --include="*_test.go"
go test -c ./internal/store/postgres/... 2>&1 | grep "FAIL"
```
First should return nothing (or just the files that need sqlmock).
  </verify>
  <done>pgx/v4 imports updated to v5 in internal/store/postgres test files</done>
</task>

</tasks>

<verification>
After completing all tasks, run full test compilation:

```bash
# Full compilation check
go test ./... 2>&1 | grep "FAIL.*setup failed" | wc -l
# Target: 0 (all packages compile)

# If some packages still fail due to sqlmock, verify it's only those:
go test ./... 2>&1 | grep "FAIL" | grep -v "internal/store/postgres" | grep -v "store/postgres"
# Should return nothing (only postgres store tests may still need sqlmock)

# Run tests
go test ./... -v 2>&1 | tail -50
# Check for test passes/failures (compilation must succeed)
```

**CI Verification:**
```bash
# Race detector
go test -race ./... 2>&1 | head -20

# Coverage (if all compiles)
go test -coverprofile=coverage.out ./... 2>&1
go tool cover -func=coverage.out | grep total
```
</verification>

<success_criteria>
- [ ] jwt.Parser.Parts() replaced with strings.Split()
- [ ] Unused variables and imports fixed in internal/auth
- [ ] Pagination test assertion updated to match API
- [ ] LocationHandler field removed from integration test
- [ ] pgx/v4 imports fixed in internal/store/postgres
- [ ] `go test ./...` compiles all packages (0 setup failures)
- [ ] Tests run (may have test failures, but no compilation failures)
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-repair/27-04-SUMMARY.md`
</output>
