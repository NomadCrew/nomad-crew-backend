---
phase: 13-oracle-cloud-setup
plan: 01
type: execute
---

<objective>
Set up Oracle Cloud Infrastructure (OCI) with Always Free ARM compute instance for NomadCrew backend deployment.

Purpose: Establish free, production-ready compute infrastructure to replace Google Cloud Run ($24/month savings).
Output: Running ARM instance (4 OCPU, 24 GB RAM) with SSH access and ports 22, 80, 443 open.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-oracle-cloud-setup/13-RESEARCH.md

**From RESEARCH.md - Critical guidance:**
- Upgrade to Pay-As-You-Go immediately (free, prevents capacity issues and idle reclamation)
- Recommended regions: US-ASHBURN-1, UK-LONDON-1, AP-SYDNEY-1
- Avoid: San Jose, Tokyo, Singapore, Amsterdam (capacity issues)
- Two firewalls required: OCI Security Lists + OS iptables
- ARM free tier: 4 OCPU, 24 GB RAM, 200 GB storage total
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Oracle Cloud account and upgrade to Pay-As-You-Go</action>
  <instructions>
    This step requires human action - no API can create an OCI account.

    **1. Create Oracle Cloud Account:**
    - Visit: https://www.oracle.com/cloud/free/
    - Click "Start for free"
    - **CRITICAL: Select region carefully** - recommended: US East (Ashburn) or UK South (London)
    - Region cannot be changed after account creation!
    - Complete identity verification (may require credit card)

    **2. Upgrade to Pay-As-You-Go (PAYG):**
    - This is FREE - you won't be charged unless you exceed Always Free limits
    - Benefits: Priority for ARM instance creation, no idle reclamation
    - Go to: OCI Console > Billing > Upgrade to Paid
    - Follow prompts (requires payment method for verification only)

    **3. Note your home region:**
    - Record the region code (e.g., `us-ashburn-1`, `uk-london-1`)
    - This will be used in Terraform configuration
  </instructions>
  <verification>
    - Can log into OCI Console at https://cloud.oracle.com
    - Account shows "Pay As You Go" (not "Free Tier" or "Trial")
    - Home region is noted
  </verification>
  <resume-signal>Type "done" with your region code (e.g., "done us-ashburn-1")</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create Terraform infrastructure configuration</name>
  <files>infrastructure/oracle/main.tf, infrastructure/oracle/variables.tf, infrastructure/oracle/outputs.tf, infrastructure/oracle/terraform.tfvars.example</files>
  <action>
    Create Terraform configuration for OCI Always Free infrastructure based on RESEARCH.md patterns.

    **Directory structure:**
    ```
    infrastructure/oracle/
    ├── main.tf              # Main resources (VCN, subnet, instance)
    ├── variables.tf         # Input variables
    ├── outputs.tf           # Outputs (IP address, instance ID)
    └── terraform.tfvars.example  # Example variables file
    ```

    **main.tf must include:**
    - Terraform block with OCI provider >= 6.0
    - Data sources for availability domain and Ubuntu ARM image
    - oci_identity_compartment for nomadcrew resources
    - oci_core_vcn with CIDR 10.0.0.0/16
    - oci_core_internet_gateway for outbound connectivity
    - oci_core_route_table with default route to IGW
    - oci_core_security_list with ingress for ports 22, 80, 443 and ICMP type 3 code 4
    - oci_core_subnet (public, 10.0.0.0/24)
    - oci_core_instance with VM.Standard.A1.Flex shape (4 OCPU, 24 GB)

    **variables.tf must include:**
    - tenancy_ocid (required)
    - user_ocid (required)
    - fingerprint (required)
    - private_key_path (required)
    - region (default: us-ashburn-1)
    - ssh_public_key_path (default: ~/.ssh/id_rsa.pub)

    **outputs.tf must include:**
    - instance_public_ip
    - instance_id
    - ssh_command (formatted SSH connection string)

    **terraform.tfvars.example:**
    - Placeholder values with instructions for obtaining each OCID

    Use patterns from RESEARCH.md code_examples section. Do NOT use deprecated resources or patterns.
  </action>
  <verify>
    cd infrastructure/oracle && terraform init succeeds (downloads OCI provider)
    terraform validate succeeds
  </verify>
  <done>
    Terraform configuration validates successfully. Files created in infrastructure/oracle/.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure OCI API credentials and deploy infrastructure</action>
  <instructions>
    I've created the Terraform configuration. Now you need to configure credentials and deploy.

    **1. Generate API Key Pair:**
    ```bash
    # Generate key (if you don't have one)
    mkdir -p ~/.oci
    openssl genrsa -out ~/.oci/oci_api_key.pem 2048
    chmod 600 ~/.oci/oci_api_key.pem
    openssl rsa -pubout -in ~/.oci/oci_api_key.pem -out ~/.oci/oci_api_key_public.pem
    ```

    **2. Add Public Key to OCI:**
    - OCI Console > Profile (top right) > My Profile > API Keys > Add API Key
    - Choose "Paste Public Key"
    - Paste contents of `~/.oci/oci_api_key_public.pem`
    - Copy the "Configuration File Preview" shown after adding

    **3. Create terraform.tfvars:**
    ```bash
    cd infrastructure/oracle
    cp terraform.tfvars.example terraform.tfvars
    ```
    Edit terraform.tfvars with values from the Configuration File Preview:
    - tenancy_ocid = "ocid1.tenancy.oc1..xxx"
    - user_ocid = "ocid1.user.oc1..xxx"
    - fingerprint = "xx:xx:xx..."
    - private_key_path = "~/.oci/oci_api_key.pem"
    - region = "[your-region]"
    - ssh_public_key_path = "~/.ssh/id_rsa.pub"

    **4. Generate SSH Key (if needed):**
    ```bash
    ssh-keygen -t rsa -b 4096 -f ~/.ssh/oci_nomadcrew -N ""
    ```
    Update ssh_public_key_path in terraform.tfvars if using a different key.

    **5. Deploy Infrastructure:**
    ```bash
    cd infrastructure/oracle
    terraform init
    terraform plan
    terraform apply
    ```

    **If "Out of Capacity" error:**
    - Wait and retry (capacity is released periodically)
    - Try different availability domain (AD-1, AD-2, AD-3)
    - Consider using retry script: https://github.com/hitrov/oci-arm-host-capacity

    **6. Record Output:**
    After successful apply, note the `instance_public_ip` output.
  </instructions>
  <verification>
    - terraform apply completes successfully
    - instance_public_ip is displayed
    - Can ping the IP address (may fail until iptables configured)
  </verification>
  <resume-signal>Type "deployed" with the public IP (e.g., "deployed 129.146.xxx.xxx")</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create OS firewall setup script</name>
  <files>infrastructure/oracle/scripts/setup-firewall.sh</files>
  <action>
    Create a shell script to configure iptables on the Ubuntu instance.

    **Script must:**
    - Open ports 80 (HTTP), 443 (HTTPS)
    - Install iptables-persistent to survive reboots
    - Save rules with netfilter-persistent
    - Display verification output

    **Script header:**
    ```bash
    #!/bin/bash
    set -e
    echo "Configuring OS firewall for NomadCrew backend..."
    ```

    Use pattern from RESEARCH.md "OS-Level Firewall Setup Script" section.

    Add a README.md in infrastructure/oracle/ explaining:
    - How to run terraform
    - How to SSH to instance
    - How to run firewall setup script
    - What ports are open and why
  </action>
  <verify>
    Script is executable: ls -la infrastructure/oracle/scripts/setup-firewall.sh shows -rwxr-xr-x
    Script has valid bash syntax: bash -n infrastructure/oracle/scripts/setup-firewall.sh
  </verify>
  <done>
    setup-firewall.sh created and passes syntax check. README.md documents usage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Oracle Cloud ARM instance with networking and Terraform configuration</what-built>
  <how-to-verify>
    **1. SSH to instance:**
    ```bash
    ssh -i ~/.ssh/[your-key] ubuntu@[instance-ip]
    ```
    Confirm you get a shell prompt.

    **2. Run firewall setup:**
    ```bash
    # Copy and run the script
    scp infrastructure/oracle/scripts/setup-firewall.sh ubuntu@[instance-ip]:~
    ssh ubuntu@[instance-ip] "chmod +x setup-firewall.sh && ./setup-firewall.sh"
    ```

    **3. Verify from local machine:**
    ```bash
    # Test SSH (port 22)
    nc -zv [instance-ip] 22

    # Test HTTP (port 80) - should connect even if nothing listening yet
    nc -zv [instance-ip] 80

    # Test HTTPS (port 443)
    nc -zv [instance-ip] 443
    ```

    **4. Verify instance specs:**
    ```bash
    ssh ubuntu@[instance-ip] "nproc && free -h"
    ```
    Should show 4 CPUs and ~24 GB memory.

    **Expected Results:**
    - SSH connection successful
    - Firewall script runs without error
    - All three ports (22, 80, 443) reachable
    - Instance shows 4 CPU cores and ~24 GB RAM
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] OCI account created with Pay-As-You-Go billing
- [ ] Terraform configuration in infrastructure/oracle/ validates
- [ ] ARM instance running with public IP
- [ ] SSH access working
- [ ] Ports 22, 80, 443 open (both Security List and iptables)
- [ ] Instance specs: 4 OCPU, 24 GB RAM confirmed
</verification>

<success_criteria>

- OCI account active with PAYG billing (prevents idle reclamation)
- ARM Ampere A1 instance running (VM.Standard.A1.Flex, 4 OCPU, 24 GB)
- VCN networking configured (public subnet with internet gateway)
- Security List allows ingress on ports 22, 80, 443
- OS-level iptables allows ports 80, 443
- SSH access verified
- Terraform state stored locally (infrastructure/oracle/terraform.tfstate)
- Instance public IP documented for Phase 14 (Coolify installation)
</success_criteria>

<output>
After completion, create `.planning/phases/13-oracle-cloud-setup/13-01-SUMMARY.md`:

# Phase 13 Plan 01: Oracle Cloud Setup Summary

**[One-liner: what was accomplished]**

## Accomplishments

- OCI account created in [region] with PAYG billing
- ARM instance provisioned: [IP address]
- Networking: VCN, public subnet, internet gateway
- Ports open: 22 (SSH), 80 (HTTP), 443 (HTTPS)

## Files Created/Modified

- `infrastructure/oracle/main.tf` - Terraform main configuration
- `infrastructure/oracle/variables.tf` - Input variables
- `infrastructure/oracle/outputs.tf` - Output values
- `infrastructure/oracle/terraform.tfvars.example` - Example variables
- `infrastructure/oracle/scripts/setup-firewall.sh` - OS firewall script
- `infrastructure/oracle/README.md` - Usage documentation

## Decisions Made

- Region: [selected region and why]
- Instance size: Full 4 OCPU / 24 GB (single instance vs split)

## Issues Encountered

[Any capacity issues, workarounds needed, etc.]

## Next Phase Readiness

Ready for Phase 14: Coolify Installation
- Instance IP: [xxx.xxx.xxx.xxx]
- SSH access confirmed
- Docker installation next step
</output>
