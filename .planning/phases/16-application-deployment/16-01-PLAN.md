---
phase: 16-application-deployment
plan: 01
type: execute
---

<objective>
Deploy NomadCrew Go backend via Coolify with environment configuration and health verification.

Purpose: Complete the migration from Cloud Run by deploying the application to the AWS EC2 instance via Coolify.
Output: Running application accessible via Coolify, all health checks passing, external services connected.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cicd-pipeline-migration/15-01-SUMMARY.md
@.planning/phases/15-cicd-pipeline-migration/15-02-SUMMARY.md

**Prior Phase Context:**
- Coolify v4.0.0-beta.460 installed at http://3.130.209.141:8000
- Application "nomad-crew-backend" created with GitHub App integration
- Dockerfile build pack configured, port 8080
- Auto-deploy enabled (triggers on push to main)
- EC2 instance: t4g.small ARM Graviton

**Coolify Dashboard:** http://3.130.209.141:8000
**Admin:** admin@nomadcrew.uk

**Environment Variables Required (from .env.example.production):**

| Variable | Description | Source |
|----------|-------------|--------|
| DATABASE_URL | Neon PostgreSQL connection | Neon Dashboard |
| PORT | Application port | 8080 (hardcode) |
| SERVER_ENVIRONMENT | Environment name | production |
| ALLOWED_ORIGINS | CORS origins | Frontend URL(s) |
| FRONTEND_URL | Frontend URL | Frontend URL |
| REDIS_ADDRESS | Upstash Redis host:port | Upstash Dashboard |
| REDIS_PASSWORD | Upstash Redis password | Upstash Dashboard |
| REDIS_DB | Redis database number | 0 |
| REDIS_USE_TLS | TLS for Redis | true |
| EMAIL_FROM_ADDRESS | Sender email | notifications@nomadcrew.uk |
| EMAIL_FROM_NAME | Sender name | NomadCrew |
| RESEND_API_KEY | Resend email API key | Resend Dashboard |
| GEOAPIFY_KEY | Geoapify API key | Geoapify Dashboard |
| PEXELS_API_KEY | Pexels API key | Pexels Dashboard |
| SUPABASE_ANON_KEY | Supabase anonymous key | Supabase Dashboard |
| SUPABASE_SERVICE_KEY | Supabase service key | Supabase Dashboard |
| SUPABASE_URL | Supabase project URL | Supabase Dashboard |
| SUPABASE_JWT_SECRET | Supabase JWT secret | Supabase Dashboard |
| JWT_SECRET_KEY | App JWT secret | Generate or existing |
| LOG_LEVEL | Logging level | info |

@Dockerfile
@.env.example.production
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure environment variables in Coolify dashboard</action>
  <instructions>
    **Go to Coolify dashboard:** http://3.130.209.141:8000

    **Navigate to:** Projects → default → production → nomad-crew-backend → Environment Variables

    **Add the following environment variables (one by one or bulk paste):**

    ```
    PORT=8080
    SERVER_ENVIRONMENT=production
    LOG_LEVEL=info
    REDIS_DB=0
    REDIS_USE_TLS=true
    EMAIL_FROM_ADDRESS=notifications@nomadcrew.uk
    EMAIL_FROM_NAME=NomadCrew
    ```

    **Copy sensitive values from your existing Cloud Run configuration or dashboards:**

    1. **From Neon Dashboard (https://neon.tech):**
       - DATABASE_URL (use pooler connection string with sslmode=require)

    2. **From Upstash Dashboard (https://console.upstash.com):**
       - REDIS_ADDRESS (e.g., actual-serval-57447.upstash.io:6379)
       - REDIS_PASSWORD

    3. **From Supabase Dashboard (https://supabase.com):**
       - SUPABASE_URL
       - SUPABASE_ANON_KEY
       - SUPABASE_SERVICE_KEY
       - SUPABASE_JWT_SECRET

    4. **From Resend Dashboard (https://resend.com):**
       - RESEND_API_KEY

    5. **From API providers:**
       - GEOAPIFY_KEY
       - PEXELS_API_KEY

    6. **From existing deployment or generate new:**
       - JWT_SECRET_KEY (minimum 32 characters)
       - ALLOWED_ORIGINS (comma-separated, e.g., https://nomadcrew.uk)
       - FRONTEND_URL (e.g., https://nomadcrew.uk)

    **Important:**
    - Mark all sensitive variables (passwords, keys) as "Secret" in Coolify
    - Double-check DATABASE_URL has `?sslmode=require` suffix for Neon
    - Verify REDIS_USE_TLS=true for Upstash
  </instructions>
  <verification>
    All 20 environment variables should be visible in the Coolify Environment Variables section.
    Sensitive values should show as masked/secret.
  </verification>
  <resume-signal>Type "env configured" when all environment variables are added</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure health check and trigger first deployment</action>
  <instructions>
    **In Coolify dashboard for nomad-crew-backend:**

    1. **Navigate to:** Settings or Configuration section

    2. **Configure Health Check:**
       - Path: `/health/liveness`
       - Interval: 30 seconds
       - Timeout: 10 seconds
       - Retries: 3
       - Port: 8080

    3. **Save configuration** and click **Deploy** button (top right)

    4. **Watch the build logs:**
       - Should pull from GitHub
       - Build with Dockerfile (multi-stage: golang:1.24-alpine → alpine:latest)
       - Start container with health checks

    5. **Wait for:**
       - Build: should take 1-3 minutes
       - Health check: should pass within 30 seconds of start

    **If build fails:**
    - Check logs for specific error
    - Common issues: missing env vars, Docker build errors
    - Report error message
  </instructions>
  <verification>
    Coolify shows: Container running, health check passing (green status).
    Build logs show successful Go build and container start.
  </verification>
  <resume-signal>Type "deployed" when deployment succeeds, or describe error if failed</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Deployed NomadCrew backend to AWS EC2 via Coolify</what-built>
  <how-to-verify>
    **1. Get the application URL from Coolify:**
       - In Coolify dashboard, find the assigned URL or IP:port
       - Default should be http://3.130.209.141:{coolify-assigned-port}
       - Or check if Coolify assigned a preview URL

    **2. Test health endpoint (in terminal):**
    ```bash
    curl http://{APP_URL}/health
    ```
    Expected: JSON with status "healthy", database and redis showing "connected"

    **3. Test liveness endpoint:**
    ```bash
    curl http://{APP_URL}/health/liveness
    ```
    Expected: 200 OK with basic health status

    **4. Test readiness endpoint:**
    ```bash
    curl http://{APP_URL}/health/readiness
    ```
    Expected: 200 OK confirming all dependencies ready

    **5. Test API endpoint (list trips - requires auth but should return 401, not error):**
    ```bash
    curl http://{APP_URL}/api/v1/trips
    ```
    Expected: 401 Unauthorized (auth required, but proves API is responding)

    **6. Check Coolify logs:**
       - No error loops
       - Connection established to database
       - Redis connection successful
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All 20 environment variables configured in Coolify
- [ ] Deployment successful (container running)
- [ ] Health check passing in Coolify dashboard (green status)
- [ ] `/health` endpoint returns healthy status
- [ ] `/health/liveness` returns 200
- [ ] `/health/readiness` returns 200
- [ ] Database connection working (visible in /health response)
- [ ] Redis connection working (visible in /health response)
- [ ] API endpoints responding (401 for unauthenticated, not 500)
</verification>

<success_criteria>

- Application running on Coolify
- All health checks passing
- Database and cache connections working
- API endpoints responding correctly
- No error loops in logs
</success_criteria>

<output>
After completion, create `.planning/phases/16-application-deployment/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Application Deployment Summary

**[One-liner: deployment outcome]**

## Performance
- Duration: [time]
- Started: [timestamp]
- Completed: [timestamp]
- Tasks: 3 (all checkpoints)

## Accomplishments
- Configured [N] environment variables
- Deployed via Dockerfile build
- Health checks passing
- External services connected

## Configuration Details
| Setting | Value |
|---------|-------|
| Application URL | [URL] |
| Health Check Path | /health/liveness |
| Container Port | 8080 |

## Decisions Made
[Any runtime decisions, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Phase 16 complete. Ready for **Phase 17: Domain & SSL Configuration**.

**Application URL:** [URL from Coolify]
**Coolify Dashboard:** http://3.130.209.141:8000
</output>
