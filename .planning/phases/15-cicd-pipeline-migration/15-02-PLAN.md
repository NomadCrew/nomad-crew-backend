---
phase: 15-cicd-pipeline-migration
plan: 02
type: execute
---

<objective>
Migrate GitHub Actions from Cloud Run to Coolify webhook-based deployment.

Purpose: Replace GCP-specific CI/CD with Coolify webhook triggers while preserving test and security scan jobs.
Output: New deploy-coolify.yml workflow, archived Cloud Run workflows, working automated deployment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cicd-pipeline-migration/15-01-SUMMARY.md
@.github/workflows/deploy-cloud-run.yml

**From Plan 15-01:**
- Coolify Webhook URL: [from 15-01]
- Coolify Webhook Secret: [from 15-01]

**Current Workflows:**
- deploy-cloud-run.yml - Main production deployment (to replace)
- pr-preview-cloud-run.yml - PR preview environments (to archive)
- pr-cleanup-cloud-run.yml - PR cleanup (to archive)
- deploy-swagger-ui.yml - Swagger docs (keep as-is)
- golang-cilint.yml - Linting (keep as-is)
- test.yml - Tests (keep as-is)

**Existing Workflow Structure (to preserve):**
- Test job with Postgres/Redis services
- Security scan job (Gosec + Trivy)
- Deploy job (to replace with webhook trigger)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Coolify deployment workflow</name>
  <files>.github/workflows/deploy-coolify.yml</files>
  <action>
Create new GitHub Actions workflow that:
1. Triggers on push to main branch
2. Runs existing test job (copy from deploy-cloud-run.yml)
3. Runs existing security-scan job (copy from deploy-cloud-run.yml)
4. Adds deploy job that triggers Coolify webhook:
   - Uses curl to POST to Coolify webhook URL
   - Includes webhook secret in header
   - Only runs after tests and security scan pass

**Webhook trigger structure:**
```yaml
deploy:
  name: Trigger Coolify Deploy
  needs: [test, security-scan]
  runs-on: ubuntu-latest
  steps:
    - name: Trigger Coolify Webhook
      run: |
        curl -X POST "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
          -H "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_SECRET }}" \
          -H "Content-Type: application/json" \
          --fail --silent --show-error

    - name: Deployment Triggered
      run: echo "Deployment triggered on Coolify. Check http://3.130.209.141:8000 for status."
```

**Do NOT include:**
- Any GCP-specific configuration
- Artifact Registry or GCR references
- Cloud Run deployment steps
- GCP_SA_KEY secret usage
  </action>
  <verify>cat .github/workflows/deploy-coolify.yml shows complete workflow with test, security-scan, and deploy jobs</verify>
  <done>deploy-coolify.yml created with test, security-scan, and Coolify webhook trigger jobs</done>
</task>

<task type="auto">
  <name>Task 2: Archive Cloud Run workflows</name>
  <files>.github/workflows-archived/deploy-cloud-run.yml, .github/workflows-archived/pr-preview-cloud-run.yml, .github/workflows-archived/pr-cleanup-cloud-run.yml</files>
  <action>
Move Cloud Run workflows to archive directory:
1. Create `.github/workflows-archived/` directory
2. Move deploy-cloud-run.yml to workflows-archived/
3. Move pr-preview-cloud-run.yml to workflows-archived/
4. Move pr-cleanup-cloud-run.yml to workflows-archived/

**Why archive instead of delete:**
- Preserves history for reference
- Easy rollback if Coolify has issues
- Documents what was removed
- Git tracks the move

**Keep active (do not archive):**
- deploy-swagger-ui.yml
- golang-cilint.yml
- test.yml
  </action>
  <verify>ls .github/workflows-archived/ shows 3 Cloud Run workflow files; ls .github/workflows/ shows only deploy-coolify.yml, deploy-swagger-ui.yml, golang-cilint.yml, test.yml</verify>
  <done>Cloud Run workflows archived to .github/workflows-archived/, active workflows directory cleaned</done>
</task>

<task type="auto">
  <name>Task 3: Document required GitHub secrets</name>
  <files>.github/SECRETS.md</files>
  <action>
Create documentation for required GitHub repository secrets:

**New secrets needed (add to GitHub repo settings):**
- `COOLIFY_WEBHOOK_URL` - Coolify webhook endpoint from Plan 15-01
- `COOLIFY_WEBHOOK_SECRET` - Coolify webhook authentication secret from Plan 15-01

**Secrets to remove (after successful migration):**
- `GCP_SA_KEY` - Google Cloud service account key

**Secrets to keep (used by remaining workflows or future use):**
- None from the Cloud Run deployment (all were GCP-specific)

Document in .github/SECRETS.md with:
- Secret name
- Purpose
- Where to obtain
- Status (Required/Optional/Deprecated)
  </action>
  <verify>cat .github/SECRETS.md shows documentation of COOLIFY_WEBHOOK_URL and COOLIFY_WEBHOOK_SECRET</verify>
  <done>SECRETS.md created documenting required GitHub secrets for Coolify deployment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `.github/workflows/deploy-coolify.yml` exists with test, security-scan, and deploy jobs
- [ ] Cloud Run workflows moved to `.github/workflows-archived/`
- [ ] `.github/SECRETS.md` documents required secrets
- [ ] No GCP references remain in active workflows
- [ ] Workflow syntax valid (can check with `gh workflow view deploy-coolify.yml` or GitHub UI)
</verification>

<success_criteria>
- New Coolify deployment workflow created
- Cloud Run workflows archived (not deleted)
- Secret requirements documented
- Ready for Phase 16 (Application Deployment with env vars)
</success_criteria>

<output>
After completion, create `.planning/phases/15-cicd-pipeline-migration/15-02-SUMMARY.md`:

# Phase 15 Plan 02: GitHub Workflow Migration Summary

**[One-liner summary]**

## Accomplishments

- Created deploy-coolify.yml workflow
- Archived 3 Cloud Run workflows
- Documented GitHub secrets requirements

## Files Created/Modified

- `.github/workflows/deploy-coolify.yml` - New Coolify deployment workflow
- `.github/workflows-archived/deploy-cloud-run.yml` - Archived
- `.github/workflows-archived/pr-preview-cloud-run.yml` - Archived
- `.github/workflows-archived/pr-cleanup-cloud-run.yml` - Archived
- `.github/SECRETS.md` - Secrets documentation

## Workflow Comparison

| Aspect | Cloud Run (Old) | Coolify (New) |
|--------|----------------|---------------|
| Test Job | PostgreSQL + Redis services | Same |
| Security Scan | Gosec + Trivy | Same |
| Deploy | Build + Push + gcloud deploy | Webhook trigger |
| Secrets | GCP_SA_KEY, many GCP vars | COOLIFY_WEBHOOK_URL/SECRET |

## Decisions Made

[Any decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 15 complete. Ready for Phase 16: Application Deployment

**IMPORTANT:** Before first deployment:
1. Add COOLIFY_WEBHOOK_URL to GitHub secrets
2. Add COOLIFY_WEBHOOK_SECRET to GitHub secrets
3. Configure environment variables in Coolify (Phase 16)
</output>
