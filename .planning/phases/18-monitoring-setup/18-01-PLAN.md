---
phase: 18-monitoring-setup
plan: 01
type: execute
domain: infrastructure
---

<objective>
Set up Grafana Cloud monitoring for NomadCrew backend with uptime checks and alerting.

Purpose: Ensure production visibility and get alerted when API is down before users report issues.
Output: Grafana Cloud dashboard with synthetic checks, uptime alerts, and optional metrics collection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-domain-ssl-config/17-01-SUMMARY.md

**Infrastructure Context:**
- Production URL: https://api.nomadcrew.uk
- EC2 Instance: m8g.large (4 vCPU, 16 GB) at 3.130.209.141
- Coolify Dashboard: http://3.130.209.141:8000
- Existing endpoints: /health, /health/liveness, /health/readiness, /metrics

**Discovery Findings:**
Grafana Cloud Free Tier provides:
- 10,000 Prometheus metrics series
- 50GB logs/month
- Synthetic Monitoring checks (HTTP probes from global locations)
- Alerting included

Two monitoring approaches:
1. **Synthetic Monitoring (recommended start):** Cloud-based HTTP checks, no agent needed
2. **Full Observability:** Grafana Alloy agent for metrics/logs push (optional enhancement)

This plan implements Synthetic Monitoring first as it provides immediate value with zero infrastructure changes.
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Grafana Cloud free account</action>
  <instructions>
    I'll guide you through the account setup. This requires email verification.

    1. Visit: https://grafana.com/auth/sign-up/create-user
    2. Sign up with email (use admin@nomadcrew.uk or personal email)
    3. Select "Free" tier when prompted
    4. Complete email verification
    5. Note your Grafana Cloud stack URL (e.g., yourname.grafana.net)
  </instructions>
  <verification>You should see the Grafana Cloud home dashboard</verification>
  <resume-signal>Provide your Grafana Cloud stack URL (e.g., "mystack.grafana.net")</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create HTTP uptime checks via Synthetic Monitoring</action>
  <instructions>
    Create synthetic checks for the key API endpoints:

    **Check 1: Health Check (Critical)**
    1. Navigate to: Testing & synthetics > Synthetics
    2. Click "Add new check" > "API Endpoint"
    3. Configure:
       - Name: NomadCrew API Health
       - URL: https://api.nomadcrew.uk/health
       - Frequency: 1 minute
       - Probe locations: Select 2-3 (e.g., New York, Frankfurt, Singapore)
       - Assertions: HTTP status code equals 200
    4. Click "Save"

    **Check 2: Liveness Probe**
    1. Add new check > API Endpoint
    2. Configure:
       - Name: NomadCrew Liveness
       - URL: https://api.nomadcrew.uk/health/liveness
       - Frequency: 1 minute
       - Probe locations: Same as above
       - Assertions: HTTP status code equals 200
    3. Click "Save"

    **Check 3: API Auth Endpoint (validates routing)**
    1. Add new check > API Endpoint
    2. Configure:
       - Name: NomadCrew API v1
       - URL: https://api.nomadcrew.uk/v1/trips
       - Frequency: 5 minutes
       - Probe locations: Same as above
       - Assertions: HTTP status code equals 401 (auth required = routing works)
    3. Click "Save"
  </instructions>
  <verification>You should see 3 checks in the Synthetics dashboard, all showing "Passing" or "Reachable"</verification>
  <resume-signal>Type "checks created" when all 3 synthetic checks are configured and showing green</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure alerting for downtime</action>
  <instructions>
    Set up alerts to notify when the API is down:

    **Create Alert Rule:**
    1. Navigate to: Alerting > Alert rules
    2. Click "New alert rule"
    3. Configure:
       - Name: NomadCrew API Down
       - Query: Use the synthetic monitoring metrics
         - Select "Grafana Cloud Synthetic Monitoring" as data source
         - Metric: probe_success
         - Filter: job="NomadCrew API Health"
       - Condition: When probe_success < 1 for 5 minutes
       - Evaluation: Every 1 minute, for 5 minutes
    4. Add labels: severity=critical, service=nomadcrew-api
    5. Click "Save and exit"

    **Create Contact Point (Email):**
    1. Navigate to: Alerting > Contact points
    2. Click "Add contact point"
    3. Configure:
       - Name: NomadCrew Team
       - Type: Email
       - Addresses: your-email@example.com
    4. Click "Save"

    **Link Alert to Contact Point:**
    1. Navigate to: Alerting > Notification policies
    2. Edit the default policy or create new
    3. Set contact point to "NomadCrew Team"
    4. Save
  </instructions>
  <verification>Test alert by temporarily breaking a check URL, or use "Test" button on contact point</verification>
  <resume-signal>Type "alerts configured" when alerting is set up</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Grafana Cloud account created and accessible
- [ ] 3 synthetic checks created (health, liveness, API v1)
- [ ] All checks showing green/passing status
- [ ] Alert rule configured for downtime detection
- [ ] Contact point configured for notifications
- [ ] Test notification sent successfully
</verification>

<success_criteria>

- Grafana Cloud free account operational
- Synthetic monitoring checks running every 1-5 minutes
- Alerting configured for API downtime
- Team notified when API is unreachable
</success_criteria>

<output>
After completion, create `.planning/phases/18-monitoring-setup/18-01-SUMMARY.md` with:

# Phase 18 Plan 01: Monitoring Setup Summary

**[Grafana Cloud synthetic monitoring configured with uptime checks and alerting]**

## Accomplishments
- Grafana Cloud account created
- Synthetic checks for health, liveness, API endpoints
- Alert rules for downtime detection
- Email notifications configured

## Configuration Details
| Setting | Value |
|---------|-------|
| Grafana Cloud URL | [stack].grafana.net |
| Checks Created | 3 |
| Check Frequency | 1-5 min |
| Probe Locations | [list] |
| Alert Threshold | 5 min downtime |

## Decisions Made
[Document any choices made during setup]

## Issues Encountered
[Document any problems and resolutions]

## Next Phase Readiness
Ready for Phase 19: Cloud Run Decommissioning
- Monitoring in place to detect issues during migration cutover
- 48+ hour stability window can begin
</output>
