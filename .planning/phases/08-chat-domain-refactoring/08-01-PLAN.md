# Phase 08: Chat Domain Refactoring - Plan 01

## Handler Consolidation and Pattern Standardization

**Created:** 2026-01-12
**Status:** Ready for Execution
**Estimated Tasks:** 8

---

## Context

### Current State Analysis

The chat domain has **two competing implementations**:

| Component | Location | Status | Used In Production |
|-----------|----------|--------|-------------------|
| `ChatHandlerSupabase` | `handlers/chat_handler_supabase.go` | Active | ✅ Yes (main.go:262, router.go) |
| `ChatHandler` | `handlers/chat_handler.go` | Unused | ❌ No |
| `ChatServiceImpl` | `models/chat/service/chat_service.go` | Unused | ❌ No |
| `SupabaseService.SendChatMessage` | `services/supabase_service.go` | Active | ✅ Yes |

**Architecture Decision:**
- Frontend connects directly to Supabase Realtime for chat messages
- Backend handles: authorization (trip membership), message creation in Supabase, notifications
- `ChatHandlerSupabase` is the correct active handler

### Pattern Violations Identified

`ChatHandlerSupabase` (370 lines) does NOT follow established patterns:

| Pattern | Expected | Current |
|---------|----------|---------|
| JSON binding | `bindJSONOrError(c, &req)` | Inline `c.ShouldBindJSON(&req)` |
| User ID extraction | `getUserIDFromContext(c)` | `c.GetString(string(middleware.UserIDKey))` |
| Error responses | `c.Error(errors.X())` | `c.JSON(http.StatusX, gin.H{"error": "..."})` |
| Request structs | Defined in `types/` | Inline anonymous structs |

### Missing Functionality

`ChatHandler` (440 lines) has notification support that `ChatHandlerSupabase` lacks:
- `SendChatMessage` in `ChatHandler` calls `notificationService.SendChatMessage()`
- This notifies trip members when someone sends a chat message
- `ChatHandlerSupabase` does NOT send notifications

---

## Objective

1. **Standardize `ChatHandlerSupabase`** with established handler patterns
2. **Add notification support** from `ChatHandler` into `ChatHandlerSupabase`
3. **Deprecate unused code** (`ChatHandler`, optionally `ChatServiceImpl`)
4. **Improve code quality** with consistent error handling and request types

---

## Tasks

### Task 1: Add request/response types to types/chat.go

**File:** `types/chat.go`

**Action:** Add missing request types used by chat handlers

```go
// ChatMessageRequest represents a request to send a chat message
type ChatMessageRequest struct {
    Message   string  `json:"message" binding:"required,min=1,max=1000"`
    ReplyToID *string `json:"replyToId,omitempty"`
}

// ChatReactionRequest represents a request to add a reaction
type ChatReactionRequest struct {
    Emoji string `json:"emoji" binding:"required,max=10"`
}

// ChatReadStatusRequest represents a request to update read status
type ChatReadStatusRequest struct {
    LastReadMessageID string `json:"lastReadMessageId" binding:"required"`
}

// ChatMessageResponse represents a chat message response
type ChatMessageResponse struct {
    ID        string     `json:"id"`
    TripID    string     `json:"tripId"`
    UserID    string     `json:"userId"`
    Message   string     `json:"message"`
    ReplyToID *string    `json:"replyToId,omitempty"`
    CreatedAt time.Time  `json:"createdAt"`
}

// ChatMessagesResponse represents paginated chat messages
type ChatMessagesResponse struct {
    Messages   []ChatMessageResponse `json:"messages"`
    Pagination ChatPagination        `json:"pagination"`
}

// ChatPagination represents pagination info for chat
type ChatPagination struct {
    HasMore    bool    `json:"has_more"`
    NextCursor *string `json:"next_cursor"`
    Limit      int     `json:"limit"`
    Before     string  `json:"before,omitempty"`
}
```

**Verification:**
- [ ] Types compile without errors
- [ ] No duplicate type definitions

---

### Task 2: Refactor SendMessage to use established patterns

**File:** `handlers/chat_handler_supabase.go`

**Current (lines 50-124):**
```go
func (h *ChatHandlerSupabase) SendMessage(c *gin.Context) {
    tripID := c.Param("id")
    supabaseUserID := c.GetString(string(middleware.UserIDKey))

    if tripID == "" {
        c.JSON(http.StatusBadRequest, gin.H{"error": "Trip ID is required"})
        return
    }
    // ... inline struct, inline error handling
}
```

**Refactored:**
```go
func (h *ChatHandlerSupabase) SendMessage(c *gin.Context) {
    tripID := c.Param("id")
    if tripID == "" {
        _ = c.Error(errors.ValidationFailed("missing_trip_id", "trip ID is required"))
        return
    }

    userID := getUserIDFromContext(c)
    if userID == "" {
        _ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated"))
        return
    }

    // Verify user is a member of the trip
    member, err := h.tripService.GetTripMember(c.Request.Context(), tripID, userID)
    if err != nil || member == nil || member.DeletedAt != nil {
        _ = c.Error(errors.Forbidden("not_trip_member", "you are not an active member of this trip"))
        return
    }

    var req types.ChatMessageRequest
    if !bindJSONOrError(c, &req) {
        return
    }

    // Trim and validate
    req.Message = strings.TrimSpace(req.Message)
    if req.Message == "" {
        _ = c.Error(errors.ValidationFailed("empty_message", "message cannot be empty"))
        return
    }

    // ... rest of implementation
}
```

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `bindJSONOrError(c, &req)`
- [ ] Uses `c.Error()` for all error cases
- [ ] Uses `types.ChatMessageRequest`

---

### Task 3: Refactor GetMessages to use established patterns

**File:** `handlers/chat_handler_supabase.go`

**Current (lines 140-185):** Uses inline error handling

**Refactored:** Apply same patterns as Task 2

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `c.Error()` for error responses
- [ ] Uses `types.ChatMessagesResponse` for response

---

### Task 4: Refactor AddReaction to use established patterns

**File:** `handlers/chat_handler_supabase.go`

**Current (lines 202-257):** Uses inline struct and error handling

**Refactored:**
```go
func (h *ChatHandlerSupabase) AddReaction(c *gin.Context) {
    tripID := c.Param("id")
    messageID := c.Param("messageId")

    if tripID == "" || messageID == "" {
        _ = c.Error(errors.ValidationFailed("missing_ids", "trip ID and message ID are required"))
        return
    }

    userID := getUserIDFromContext(c)
    if userID == "" {
        _ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated"))
        return
    }

    // ... membership check with c.Error()

    var req types.ChatReactionRequest
    if !bindJSONOrError(c, &req) {
        return
    }

    // ... rest of implementation
}
```

**Verification:**
- [ ] Uses `types.ChatReactionRequest`
- [ ] Uses `bindJSONOrError(c, &req)`
- [ ] Uses `c.Error()` for all error cases

---

### Task 5: Refactor RemoveReaction to use established patterns

**File:** `handlers/chat_handler_supabase.go`

**Current (lines 273-315):** Uses inline error handling

**Refactored:** Apply same patterns

**Verification:**
- [ ] Uses `getUserIDFromContext(c)`
- [ ] Uses `c.Error()` for error responses

---

### Task 6: Refactor UpdateReadStatus to use established patterns

**File:** `handlers/chat_handler_supabase.go`

**Current (lines 331-369):** Uses inline struct and error handling

**Refactored:**
```go
func (h *ChatHandlerSupabase) UpdateReadStatus(c *gin.Context) {
    tripID := c.Param("id")
    if tripID == "" {
        _ = c.Error(errors.ValidationFailed("missing_trip_id", "trip ID is required"))
        return
    }

    userID := getUserIDFromContext(c)
    if userID == "" {
        _ = c.Error(errors.Unauthorized("not_authenticated", "user not authenticated"))
        return
    }

    // ... membership check with c.Error()

    var req types.ChatReadStatusRequest
    if !bindJSONOrError(c, &req) {
        return
    }

    // ... rest of implementation
}
```

**Verification:**
- [ ] Uses `types.ChatReadStatusRequest`
- [ ] Uses `bindJSONOrError(c, &req)`
- [ ] Uses `c.Error()` for all error cases

---

### Task 7: Add notification support to ChatHandlerSupabase

**File:** `handlers/chat_handler_supabase.go`

**Action:** Port notification logic from `ChatHandler.SendMessage` to `ChatHandlerSupabase.SendMessage`

**Changes:**

1. Add `notificationService` field to struct:
```go
type ChatHandlerSupabase struct {
    tripService         TripServiceInterface
    supabaseService     *services.SupabaseService
    notificationService *services.NotificationFacadeService  // ADD
    logger              *zap.Logger
}
```

2. Update constructor:
```go
func NewChatHandlerSupabase(
    tripService TripServiceInterface,
    supabaseService *services.SupabaseService,
    notificationService *services.NotificationFacadeService,  // ADD
) *ChatHandlerSupabase {
    return &ChatHandlerSupabase{
        tripService:         tripService,
        supabaseService:     supabaseService,
        notificationService: notificationService,  // ADD
        logger:              logger.GetLogger().Desugar(),
    }
}
```

3. Add notification sending after successful message creation (copy from ChatHandler lines 120-183):
```go
// After successful Supabase message creation
if h.notificationService != nil && h.notificationService.IsEnabled() {
    go func() {
        // ... notification logic from ChatHandler
    }()
}
```

4. Update `main.go` to pass `notificationFacadeService` to constructor

**Verification:**
- [ ] `ChatHandlerSupabase` has notification support
- [ ] `main.go` updated to pass notification service
- [ ] Notifications sent on chat message (async)

---

### Task 8: Deprecate unused ChatHandler

**File:** `handlers/chat_handler.go`

**Action:** Add deprecation notice

```go
// Deprecated: ChatHandler is superseded by ChatHandlerSupabase.
// This handler exists for reference but is not wired into the router.
// Notification support has been merged into ChatHandlerSupabase.
// TODO: Remove in Phase 12 (Final Cleanup)
type ChatHandler struct {
    // ...
}
```

**Verification:**
- [ ] Deprecation comment added
- [ ] No references to ChatHandler in router or main.go (already confirmed)

---

## Files Modified

| File | Action |
|------|--------|
| `types/chat.go` | Add request/response types |
| `handlers/chat_handler_supabase.go` | Refactor all methods, add notification support |
| `handlers/chat_handler.go` | Add deprecation notice |
| `main.go` | Update ChatHandlerSupabase constructor call |

## Files NOT Modified (Confirmed Clean)

| File | Reason |
|------|--------|
| `models/chat/service/chat_service.go` | Unused but complete - keep for potential future use |
| `services/supabase_service.go` | Already follows good patterns |
| `types/chat.go` (existing types) | Already well-defined |

---

## Success Criteria

- [ ] All 5 handler methods use `getUserIDFromContext(c)`
- [ ] All 5 handler methods use `c.Error()` for errors
- [ ] All methods with request bodies use `bindJSONOrError(c, &req)`
- [ ] All request types defined in `types/chat.go`
- [ ] Notification support working in `ChatHandlerSupabase`
- [ ] All existing tests pass
- [ ] No regressions in chat functionality

---

## Execution Order

1. Task 1: Add types (enables other tasks)
2. Tasks 2-6: Refactor handlers (can be done sequentially)
3. Task 7: Add notification support
4. Task 8: Deprecate old handler

---

## Post-Execution

After completion:
- Run `go build ./...` to verify compilation
- Run tests: `go test ./handlers/... -v`
- Manual test: Send chat message, verify notification sent
- Update STATE.md with completion

---

*Phase: 08-chat-domain-refactoring*
*Plan: 08-01*
*Created: 2026-01-12*
