# Codebase Structure

**Analysis Date:** 2026-01-10

## Directory Layout

```
nomad-crew-backend/
├── cmd/                    # CLI tools and utilities
├── config/                 # Configuration loading and environment configs
├── db/                     # Database client, migrations, and queries
│   ├── migrations/        # SQL migration files
│   └── queries/           # SQLC query definitions
├── docs/                   # Swagger documentation and guides
├── domain/                 # Domain types (minimal usage)
├── errors/                 # Application error types
├── handlers/               # HTTP request handlers
├── internal/               # Internal packages (not exported)
│   ├── auth/              # JWT and authentication
│   ├── errors/            # Internal error types
│   ├── events/            # Event service and Redis pub/sub
│   ├── handlers/          # Internal handlers (location)
│   ├── notification/      # Push notification client
│   ├── sqlc/              # SQLC generated code
│   ├── store/             # Store interfaces and adapters
│   │   ├── mocks/        # Mock implementations
│   │   └── sqlcadapter/  # SQLC-based store implementations
│   ├── utils/             # Utility functions
│   └── websocket/         # WebSocket hub and handler
├── logger/                 # Logging configuration
├── middleware/             # HTTP middleware (auth, RBAC, CORS, etc.)
├── models/                 # Domain models and services
│   ├── chat/service/      # Chat service
│   ├── location/service/  # Location management
│   ├── notification/      # Notification service
│   ├── trip/              # Trip domain (commands, service, validation)
│   ├── user/service/      # User service
│   └── weather/service/   # Weather service
├── pkg/                    # Shared packages
│   ├── pexels/            # Pexels API client
│   └── valueobjects/      # Value object types (Money)
├── router/                 # HTTP router setup
├── scripts/                # Build and deployment scripts
├── services/               # Application services
├── store/                  # Store interfaces and legacy code
├── tests/                  # Integration tests
│   ├── integration/       # Integration test files
│   ├── mocks/             # Test mocks
│   └── testutil/          # Test utilities
├── types/                  # Shared type definitions
├── main.go                 # Application entry point
├── go.mod                  # Go module definition
└── docker-compose.yml      # Docker development setup
```

## Directory Purposes

**config/**
- Purpose: Application configuration management
- Contains: `config.go` (loading), `config.*.yaml` (env-specific), database utils
- Key files: `config.go`, `database.go`, `env_specific_config.go`
- Tests: `config_test.go`, `database_utils_test.go`

**db/**
- Purpose: Database connectivity and schema
- Contains: Database client, migrations, SQLC queries
- Key files: `db_client.go`, `migrations/000001_init.up.sql`
- Subdirectories: `migrations/` (schema), `queries/` (SQLC SQL files)

**handlers/**
- Purpose: HTTP endpoint implementations
- Contains: One handler file per domain
- Key files: `trip_handler.go`, `user_handler.go`, `todo_handler.go`, `notification_handler.go`
- Pattern: `*_handler.go` for handlers, `*_handler_test.go` for tests

**internal/sqlc/**
- Purpose: SQLC-generated type-safe database code
- Contains: Generated Go code from SQL queries
- Key files: `db.go`, `models.go`, `querier.go`, `trips.sql.go`, `users.sql.go`
- Source: Auto-generated by `sqlc generate`

**internal/store/sqlcadapter/**
- Purpose: Store implementations using SQLC
- Contains: Adapter implementations for each store interface
- Key files: `trip_store.go`, `user_store.go`, `location_store.go`, `todo_store.go`

**internal/websocket/**
- Purpose: Real-time WebSocket support
- Contains: Hub (connection manager), Handler (endpoint)
- Key files: `hub.go`, `handler.go`

**models/trip/**
- Purpose: Trip domain logic
- Contains: Model, commands, service, validation, interfaces
- Subdirectories: `command/` (CQRS commands), `service/` (business logic), `validation/`
- Key files: `model.go`, `service/trip_model_coordinator.go`

**middleware/**
- Purpose: HTTP middleware chain
- Contains: Auth, RBAC, rate limiting, CORS, error handling
- Key files: `auth.go`, `rbac.go`, `rate_limit.go`, `jwt_validator.go`, `cors.go`

**services/**
- Purpose: Application-level services
- Contains: Email, health, push notifications, Supabase
- Key files: `email_service.go`, `health_service.go`, `push_service.go`, `supabase_service.go`

**types/**
- Purpose: Shared type definitions
- Contains: Events, permissions, user types, membership
- Key files: `events.go`, `permissions.go`, `permission_matrix.go`, `membership.go`, `user.go`

## Key File Locations

**Entry Points:**
- `main.go` - Application startup, dependency injection, server start
- `router/router.go` - Route definitions and middleware wiring

**Configuration:**
- `config/config.go` - Configuration loading logic
- `config/config.development.yaml` - Development settings
- `.env.example` - Environment variable template
- `sqlc.yaml` - SQLC code generation config

**Core Logic:**
- `models/trip/model.go` - Trip aggregate root
- `models/trip/service/trip_model_coordinator.go` - Trip business logic
- `internal/events/service.go` - Event publishing/subscribing
- `internal/websocket/hub.go` - WebSocket connection management

**Database:**
- `db/db_client.go` - Database connection management
- `db/queries/*.sql` - SQLC query definitions
- `db/migrations/*.sql` - Schema migrations
- `internal/sqlc/*.go` - Generated database code

**Testing:**
- `tests/integration/*.go` - Integration tests
- `*_test.go` files - Unit tests (co-located)
- `internal/store/mocks/*.go` - Generated mock implementations

## Naming Conventions

**Files:**
- `snake_case.go` for all Go files
- `*_test.go` for test files (co-located with source)
- `*_handler.go` for HTTP handlers
- `*_service.go` for services
- `*_store.go` for store implementations

**Directories:**
- lowercase for all directories
- Plural for collections (`handlers/`, `services/`, `models/`)
- Singular for domains (`trip/`, `user/`, `location/`)

**Special Patterns:**
- `interfaces.go` for interface definitions in a package
- `mocks/` subdirectory for mock implementations
- `000XXX_name.up.sql` / `000XXX_name.down.sql` for migrations

## Where to Add New Code

**New API Endpoint:**
- Handler: `handlers/{domain}_handler.go`
- Route: `router/router.go`
- Tests: `handlers/{domain}_handler_test.go`

**New Domain/Feature:**
- Model: `models/{domain}/model.go`
- Service: `models/{domain}/service/{name}_service.go`
- Store interface: `internal/store/interfaces.go`
- Store implementation: `internal/store/sqlcadapter/{domain}_store.go`
- SQL queries: `db/queries/{domain}.sql`
- Types: `types/{domain}.go`

**New Database Table:**
- Migration: `db/migrations/000XXX_{name}.up.sql`
- Queries: `db/queries/{table}.sql`
- Run: `sqlc generate`

**New Middleware:**
- Implementation: `middleware/{name}.go`
- Tests: `middleware/{name}_test.go`
- Wire in: `router/router.go`

## Special Directories

**internal/sqlc/**
- Purpose: SQLC-generated database code
- Source: Auto-generated by `sqlc generate` from `db/queries/*.sql`
- Committed: Yes (generated code is committed)

**tmp/**
- Purpose: Air hot-reload temporary files
- Source: Generated by Air during development
- Committed: No (in .gitignore)

**.planning/**
- Purpose: Project planning and codebase documentation
- Source: Created by planning tools
- Committed: Yes

---

*Structure analysis: 2026-01-10*
*Update when directory structure changes*
