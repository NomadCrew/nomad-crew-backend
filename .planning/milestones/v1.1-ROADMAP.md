# Milestone v1.1: Infrastructure Migration to AWS

**Status:** SHIPPED 2026-01-12
**Phases:** 13-19
**Total Plans:** 8

## Overview

Migrate from Google Cloud Run ($24/month) to AWS EC2 with Coolify for cost-effective, reliable infrastructure.

**Target Stack:**
- **Compute:** AWS EC2 m8g.large (4 vCPU, 16 GB ARM Graviton4)
- **Orchestration:** Coolify v4.0.0-beta.460 (self-hosted PaaS)
- **Database:** Neon PostgreSQL (kept existing)
- **Cache:** Upstash Redis (kept existing)
- **Monitoring:** Grafana Cloud Free Tier

**Production URL:** https://api.nomadcrew.uk

---

## Phases

### Phase 13: AWS EC2 Setup
**Goal:** Provision AWS EC2 ARM Graviton instance for backend deployment
**Depends on:** None
**Plans:** 1 plan
**Completed:** 2026-01-11

Plans:
- [x] 13-01: Cloud infrastructure setup (AWS after OCI failed)

**Key Accomplishments:**
- EC2 instance running: m8g.large (4 vCPU, 16 GB ARM Graviton4)
- VPC networking: 10.0.0.0/16 with public subnet
- Security group: ports 22, 80, 443, 8000, 8081
- Elastic IP: 3.130.209.141
- Terraform IaC: infrastructure/aws/

**Note:** Originally attempted Oracle Cloud Always Free but switched to AWS due to persistent "Out of host capacity" errors after 60+ retry attempts.

---

### Phase 14: Coolify Installation
**Goal:** Install and configure Coolify on AWS EC2 for Heroku-like deployment
**Depends on:** Phase 13
**Plans:** 1 plan
**Completed:** 2026-01-11

Plans:
- [x] 14-01: Coolify installation and configuration

**Key Accomplishments:**
- Coolify v4.0.0-beta.460 installed and running
- Docker 27.0.3 installed automatically
- Admin account: admin@nomadcrew.uk
- Dashboard: http://3.130.209.141:8000
- All containers healthy (coolify, realtime, redis, db)

---

### Phase 15: CI/CD Pipeline Migration
**Goal:** Update GitHub Actions workflows for Coolify git-push deployments
**Depends on:** Phase 14
**Plans:** 2 plans
**Completed:** 2026-01-12

Plans:
- [x] 15-01: Coolify application setup with GitHub App integration
- [x] 15-02: GitHub workflow migration

**Key Accomplishments:**
- `deploy-coolify.yml` created with test and security-scan jobs
- Cloud Run workflows archived to `.github/workflows-archived/`
- GitHub secrets documented in `.github/SECRETS.md`
- Coolify GitHub App handles deployments on push

---

### Phase 16: Application Deployment
**Goal:** Deploy NomadCrew Go backend via Coolify with existing Dockerfile
**Depends on:** Phase 15
**Plans:** 1 plan
**Completed:** 2026-01-12

Plans:
- [x] 16-01: Environment configuration and health verification

**Key Accomplishments:**
- Application running at http://3.130.209.141:8081
- 20 environment variables configured
- Health checks passing (liveness, readiness, full health)
- Database (Neon) and cache (Upstash Redis) connected

---

### Phase 17: Domain & SSL Configuration
**Goal:** Configure custom domain and SSL certificates for production
**Depends on:** Phase 16
**Plans:** 1 plan
**Completed:** 2026-01-12

Plans:
- [x] 17-01: DNS configuration and SSL setup

**Key Accomplishments:**
- DNS A record: api.nomadcrew.uk -> 3.130.209.141
- Let's Encrypt SSL certificate (expires Apr 12, 2026)
- HTTP to HTTPS redirect working
- EC2 upgraded: m8g.large (4 vCPU, 16 GB Graviton4) for stability

**Note:** Instance upgraded from t4g.small to m8g.large (~$163/month) due to memory constraints with Coolify + Traefik + app.

---

### Phase 18: Monitoring Setup
**Goal:** Set up free monitoring and observability with Grafana Cloud
**Depends on:** Phase 17
**Plans:** 1 plan
**Completed:** 2026-01-12

Plans:
- [x] 18-01: Grafana Cloud setup with synthetic monitoring

**Key Accomplishments:**
- Grafana Cloud account: nomadcrew5.grafana.net
- 3 synthetic checks: health, liveness, API v1
- Discord webhook alerting for downtime
- No agent installation required (synthetic monitoring approach)

---

### Phase 19: Cloud Run Decommissioning
**Goal:** Safely shut down GCP Cloud Run and clean up resources
**Depends on:** Phase 18
**Plans:** 1 plan
**Completed:** 2026-01-12

Plans:
- [x] 19-01: GCP resource cleanup

**Key Accomplishments:**
- AWS production verified stable (1h35m+ uptime)
- Cloud Run service already deleted/never deployed (API disabled)
- Artifact Registry already deleted (API disabled)
- `GCP_SA_KEY` secret removed from GitHub
- Firebase services kept for mobile app (minimal cost)

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| AWS over Oracle Cloud | OCI Dubai had no ARM capacity after 60+ retries | Good - reliable |
| ARM Graviton instances | 20% cheaper than x86, good for Go | Good - cost effective |
| m8g.large over t4g.small | t4g.small (2GB) couldn't handle Coolify + app | Required for stability |
| Coolify over bare Docker | Heroku-like experience, GitHub App deployment | Good - easy deploys |
| Synthetic monitoring | No agent required, free tier sufficient | Good - simple |

**Issues Resolved:**
- Cloud provider capacity issues (switched from OCI to AWS)
- Memory constraints (upgraded instance)
- SSL certificate provisioning (DNS-only mode in Cloudflare)

**Cost Analysis:**

| Resource | Before | After |
|----------|--------|-------|
| Cloud Run | $24/month | $0 (deleted) |
| AWS EC2 | $0 | ~$163/month |
| **Net Change** | - | +$139/month |

Note: Cost increased due to m8g.large upgrade. Can downgrade to t4g.medium (~$28/month) if Coolify removed and app deployed directly.

**Infrastructure Details:**
- IP: 3.130.209.141
- Domain: api.nomadcrew.uk
- SSL: Let's Encrypt R12 (auto-renewing)
- Coolify Dashboard: http://3.130.209.141:8000
- Grafana: nomadcrew5.grafana.net

**Stats:**
- 7 phases completed
- 8 plans executed
- 2 days (2026-01-11 to 2026-01-12)
- Infrastructure fully migrated

---

_For current project status, see .planning/ROADMAP.md_
