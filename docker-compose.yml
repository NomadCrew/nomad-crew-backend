services:
  # Local PostgreSQL for development (optional - you can use Neon instead)
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: nomadcrew
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations/000001_init.up.sql:/docker-entrypoint-initdb.d/1_init.sql
      - ./db/migrations/000002_chat.up.sql:/docker-entrypoint-initdb.d/2_chat.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d nomadcrew"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Local Redis for development (optional - you can use Upstash instead)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-redispass}
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redispass}
      REDIS_DB: ${REDIS_DB:-0}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispass}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Development API with Air hot reloading (uses external Neon/Upstash)
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: nomadcrew-api-dev
    working_dir: /app
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot reloading
      - .:/app
      # Use named volume for Go module cache (faster rebuilds)
      - go-mod-cache:/go/pkg/mod
      # Exclude these directories - they should be managed by the container
      - /app/tmp
      - /app/vendor
      - wallet-files:/var/data/wallet-files
    env_file:
      - .env
    environment:
      # Override for development
      SERVER_ENVIRONMENT: development
      LOG_LEVEL: debug
      PORT: 8080
      WALLET_STORAGE_BACKEND: ${WALLET_STORAGE_BACKEND:-local}
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID:-}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME:-}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
    restart: unless-stopped
    # No depends_on - uses external Neon PostgreSQL and Upstash Redis

  # Production API â€” secrets are runtime env vars only, never build args
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVER_ENVIRONMENT: ${SERVER_ENVIRONMENT:-development}
        VERSION: ${VERSION:-dev}
    ports:
      - "8080:8080"
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD must be set}
      DB_NAME: ${DB_NAME:-nomadcrew}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY must be set}
      PORT: ${PORT:-8080}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:?SUPABASE_ANON_KEY must be set}
      SUPABASE_URL: ${SUPABASE_URL:?SUPABASE_URL must be set}
      PEXELS_API_KEY: ${PEXELS_API_KEY}
      REDIS_ADDRESS: "redis:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
      REDIS_DB: ${REDIS_DB:-0}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SERVER_ENVIRONMENT: ${SERVER_ENVIRONMENT:-production}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://nomadcrew.uk}
      RESEND_API_KEY: ${RESEND_API_KEY:?RESEND_API_KEY must be set}
      GEOAPIFY_KEY: ${GEOAPIFY_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:?SUPABASE_SERVICE_KEY must be set}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:?SUPABASE_JWT_SECRET must be set}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-welcome@nomadcrew.uk}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-NomadCrew}
      FRONTEND_URL: ${FRONTEND_URL:-https://nomadcrew.uk}
      EVENT_SERVICE_PUBLISH_TIMEOUT_SECONDS: ${EVENT_SERVICE_PUBLISH_TIMEOUT_SECONDS:-5}
      EVENT_SERVICE_SUBSCRIBE_TIMEOUT_SECONDS: ${EVENT_SERVICE_SUBSCRIBE_TIMEOUT_SECONDS:-10}
      EVENT_SERVICE_EVENT_BUFFER_SIZE: ${EVENT_SERVICE_EVENT_BUFFER_SIZE:-100}
      WALLET_STORAGE_BACKEND: ${WALLET_STORAGE_BACKEND:-local}
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID:-}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME:-}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
    volumes:
      - wallet-files:/var/data/wallet-files
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  go-mod-cache:
  wallet-files:
